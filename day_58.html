<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 58: Ride-Hailing Backend (Uber/Ola) | LLD Bootcamp</title>
    <!-- Chosen Palette: Slate & Sky -->
    <!-- Application Structure Plan: A two-column layout with a sticky ToC on the right for navigation and the main learning content on the left. The structure is a linear, progressive learning path: starting with foundational theory, moving to visual flow diagrams (UML), then practical coding exercises of increasing difficulty, a full case study, and finally knowledge reinforcement through a quiz and a self-assessment challenge. This sequential structure is chosen to build knowledge systematically, making complex topics digestible for a bootcamp student. -->
    <!-- Visualization & Content Choices: Report Info: Rider-Driver Matching -> Goal: Illustrate proximity -> Viz: Interactive Canvas with dots representing users -> Interaction: Button click calculates and highlights the nearest driver -> Justification: Provides a tangible, visual understanding of the core algorithm. Report Info: Surge Pricing -> Goal: Explain dynamic pricing -> Viz: Bar chart (Chart.js) -> Interaction: Sliders for demand/supply update the price multiplier on the chart -> Justification: Clearly demonstrates the cause-and-effect relationship in real-time. Report Info: Trip Sequence -> Goal: Show process flow -> Viz: HTML/CSS diagram -> Interaction: Hover effects on steps for more info -> Justification: A clear, static-but-interactive visualization of the system's logic without complex libraries. All code is presented in styled blocks with copy-to-clipboard functionality for ease of use. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .font-lexend {
            font-family: 'Lexend', sans-serif;
        }
        .toc-link.active {
            color: #0ea5e9;
            border-left-color: #0ea5e9;
            font-weight: 600;
        }
        .code-block {
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
            background-color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .copy-btn:hover {
            background-color: #cbd5e1;
            color: #1e293b;
        }
        .quiz-option {
            transition: all 0.2s ease-in-out;
        }
        .quiz-option.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }
        .quiz-option.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="bg-slate-100/80 border-b border-slate-200">
        <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 relative">
            <header class="text-center">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-800 mt-1 tracking-tight font-lexend">Low-Level Design Bootcamp</h1>
                <p class="mt-3 text-slate-600 max-w-xl mx-auto">Your 60-Day Interactive Roadmap to Mastering Backend Engineering.</p>
            </header>
             <a href="roadmap.html?week=9" class="absolute top-1/2 -translate-y-1/2 right-4 sm:right-6 lg:right-8 bg-slate-200 text-slate-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors shadow-sm">
                Return to Homepage
            </a>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="flex flex-col lg:flex-row gap-12">

            <div class="lg:w-3/4">
                <article class="space-y-12">
                    <header>
                        <p class="text-sm font-semibold text-sky-600">Day 58: Final Case Studies</p>
                        <h2 class="text-3xl sm:text-4xl font-extrabold text-slate-900 mt-2 tracking-tight font-lexend">Ride-Hailing Backend Service (Uber/Ola)</h2>
                        <p class="mt-4 text-lg text-slate-600">This lesson dives deep into the architecture of a ride-hailing service. We'll deconstruct the system into its core components, explore the critical algorithms for matching and pricing, and design a robust backend capable of handling real-world complexity, including concurrency and scalability.</p>
                    </header>

                    <section id="theory" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">✅ Theory Topics: The Architectural Blueprint</h3>
                        
                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">1. Core System Requirements (Expanded)</h4>
                            <p class="mt-3 text-slate-600">A robust system starts with a clear definition of what it must do. We'll categorize requirements into Functional (what the system does) and Non-Functional (how the system performs).</p>
                            
                            <h5 class="mt-6 text-lg font-semibold text-slate-700">Functional Requirements</h5>
                            <div class="mt-4 overflow-x-auto">
                                <table class="min-w-full bg-white border border-slate-200">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="p-3 text-left text-sm font-semibold text-slate-600">User Role</th>
                                            <th class="p-3 text-left text-sm font-semibold text-slate-600">Requirement</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200">
                                        <tr class="divide-x divide-slate-200">
                                            <td class="p-3 align-top font-semibold text-slate-700">Rider</td>
                                            <td class="p-3 text-slate-600">
                                                <ul class="list-disc list-inside space-y-1">
                                                    <li>Register and manage their profile.</li>
                                                    <li>Request a ride for various vehicle types.</li>
                                                    <li>Get a fare estimate before booking.</li>
                                                    <li>Track the driver's location in real-time.</li>
                                                    <li>Make payments through multiple methods.</li>
                                                    <li>Rate the driver and the trip.</li>
                                                    <li>View trip history.</li>
                                                </ul>
                                            </td>
                                        </tr>
                                        <tr class="divide-x divide-slate-200 bg-slate-50/50">
                                            <td class="p-3 align-top font-semibold text-slate-700">Driver</td>
                                            <td class="p-3 text-slate-600">
                                                <ul class="list-disc list-inside space-y-1">
                                                    <li>Register, onboard, and manage their profile/vehicle.</li>
                                                    <li>Set their availability (online/offline).</li>
                                                    <li>Accept or reject incoming ride requests.</li>
                                                    <li>Use in-app navigation to pickup and destination.</li>
                                                    <li>View earnings and trip history.</li>
                                                    <li>Rate the rider.</li>
                                                </ul>
                                            </td>
                                        </tr>
                                        <tr class="divide-x divide-slate-200">
                                            <td class="p-3 align-top font-semibold text-slate-700">Admin</td>
                                            <td class="p-3 text-slate-600">
                                                <ul class="list-disc list-inside space-y-1">
                                                    <li>Manage riders and drivers (view, suspend, delete).</li>
                                                    <li>Resolve customer support issues and disputes.</li>
                                                    <li>Monitor system health and ongoing trips from a dashboard.</li>
                                                    <li>Manage pricing, surge areas, and promotions.</li>
                                                </ul>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h5 class="mt-6 text-lg font-semibold text-slate-700">Non-Functional Requirements</h5>
                            <ul class="mt-4 list-disc list-inside space-y-2 text-slate-700">
                                <li><strong>High Availability:</strong> The service must be operational 24/7. System uptime should be above 99.9%.</li>
                                <li><strong>Low Latency:</strong> Key operations like finding a driver and processing a request must be fast (ideally under 2-3 seconds).</li>
                                <li><strong>Scalability:</strong> The system must handle millions of users and concurrent trips, especially during peak hours in different cities.</li>
                                <li><strong>Consistency:</strong> Trip status and user data must be consistent across the system for all parties involved (rider, driver, admin).</li>
                                <li><strong>Reliability:</strong> The system should be fault-tolerant. Failure in one component (e.g., notifications) should not bring down the entire service.</li>
                                <li><strong>Security:</strong> User data, payment information, and location data must be securely stored and transmitted.</li>
                            </ul>
                        </div>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">2. The Matching Algorithm: A Deeper Look</h4>
                            <p class="mt-3 text-slate-600">The matching process is a multi-stage funnel designed to find the best driver quickly and efficiently. The goal is to reduce the number of potential drivers at each stage to minimize expensive calculations.</p>
                            <ol class="mt-4 list-decimal list-inside space-y-2 text-slate-700">
                                <li><strong>Geospatial Indexing (The Wide Net):</strong> First, we identify all available drivers within a broad radius (e.g., 5-10 km). Searching a database of millions of drivers is slow. Instead, we use a geospatial index like <strong>Geohashing</strong> or a <strong>Quadtree</strong>. These structures partition the map into a grid, allowing us to query for drivers in a specific grid cell (and its neighbors) very quickly, without scanning the whole table.</li>
                                <li><strong>Distance Filtering (The First Cut):</strong> For the drivers found in the initial query, we calculate the straight-line distance to the rider. The <strong>Haversine formula</strong> is used here as it's computationally cheap and accurate for calculating distances on a sphere (Earth). We then filter out drivers beyond a certain distance (e.g., 5km).</li>
                                <li><strong>ETA Ranking (The Final Selection):</strong> For the remaining handful of drivers, we make calls to a mapping service (like Google Maps API) to get the real-time Estimated Time of Arrival (ETA), which accounts for traffic and road networks. This is the most accurate but also the most expensive and time-consuming step.</li>
                                <li><strong>Final Ranking:</strong> Drivers are then ranked based on a weighted score of ETA (lowest is best), Driver Rating (highest is best), and potentially other business logic (e.g., premium drivers for certain requests). The request is sent to the top-ranked driver.</li>
                            </ol>
                            <h5 class="text-md font-semibold text-slate-700 mt-4">Haversine Formula in C#</h5>
                            <p class="text-sm text-slate-600">This code calculates the great-circle distance between two points.</p>
                             <div class="code-block mt-2">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
public static double HaversineDistance(Location loc1, Location loc2)
{
    const double R = 6371; // Earth's radius in kilometers
    var lat = (loc2.Latitude - loc1.Latitude) * (Math.PI / 180);
    var lng = (loc2.Longitude - loc1.Longitude) * (Math.PI / 180);
    var h1 = Math.Sin(lat / 2) * Math.Sin(lat / 2) +
             Math.Cos(loc1.Latitude * (Math.PI / 180)) * Math.Cos(loc2.Latitude * (Math.PI / 180)) *
             Math.Sin(lng / 2) * Math.Sin(lng / 2);
    var h2 = 2 * Math.Asin(Math.Min(1, Math.Sqrt(h1)));
    return R * h2;
}
                                </code></pre>
                            </div>
                            <div class="mt-6">
                                <h5 class="font-semibold text-center text-slate-700">Interactive Matching Demo</h5>
                                <p class="text-sm text-center text-slate-500 mb-2">Click the button to find the nearest driver to the rider.</p>
                                <canvas id="matchingCanvas" class="bg-slate-50 border rounded-lg w-full h-64 mx-auto block max-w-md"></canvas>
                                <div class="text-center mt-3">
                                    <button id="findDriverBtn" class="bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 transition-colors shadow-sm">Find Nearest Driver</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">3. Pricing Model & Surge Pricing</h4>
                            <p class="mt-3 text-slate-600">Pricing is dynamic and calculated based on several factors. A transparent and predictable pricing model is key to user trust.</p>
                            <h5 class="text-md font-semibold text-slate-700 mt-4">Fare Calculation Algorithm</h5>
                            <p class="text-slate-600 mt-2">The final fare is a combination of several components, modified by the surge multiplier.</p>
                            <div class="font-mono bg-slate-100 p-4 rounded-lg text-slate-800 mt-2 text-sm">
                                <span class="text-sky-600 font-semibold">TotalFare</span> = (<span class="text-indigo-600">BaseFare</span> + (<span class="text-indigo-600">DistanceInKm</span> * <span class="text-indigo-600">PerKmRate</span>) + (<span class="text-indigo-600">DurationInMinutes</span> * <span class="text-indigo-600">PerMinuteRate</span>)) * <span class="text-red-600 font-semibold">SurgeMultiplier</span> + <span class="text-emerald-600">BookingFee</span>
                            </div>
                            <ul class="mt-4 list-disc list-inside space-y-2 text-slate-700">
                                <li><strong>Base Fare:</strong> A flat fee for starting a trip.</li>
                                <li><strong>Per-Kilometer Rate:</strong> A charge based on the distance of the trip.</li>
                                <li><strong>Per-Minute Rate:</strong> A charge based on the duration of the trip (to account for traffic).</li>
                                <li><strong>Booking Fee/Taxes:</strong> Additional platform fees and government taxes.</li>
                            </ul>
                            <h5 class="mt-6 text-lg font-semibold text-slate-800">Surge Pricing: Balancing Supply and Demand</h5>
                            <p class="mt-2 text-slate-600">Surge pricing is a mechanism to dynamically adjust prices to match supply (available drivers) with demand (riders requesting rides) in a specific geographical area. When demand outstrips supply (e.g., during rush hour, bad weather, or after a major event), prices increase. This has two effects:</p>
                            <ol class="mt-4 list-decimal list-inside space-y-2 text-slate-700">
                                <li>It incentivizes more drivers to come online or travel to the high-demand area.</li>
                                <li>It reduces demand, as some riders may choose to wait or find alternative transport.</li>
                            </ol>
                            <p class="mt-3 text-slate-600">The system continuously monitors the ratio of available drivers to rider requests in different zones. If this ratio falls below a certain threshold, a surge multiplier (e.g., 1.2x, 1.5x, 2.0x) is applied to the standard fare.</p>
                             <div class="mt-6">
                                <h5 class="font-semibold text-center text-slate-700">Interactive Surge Pricing Simulator</h5>
                                <p class="text-sm text-center text-slate-500 mb-2">Adjust the sliders to see how supply and demand affect the price multiplier.</p>
                                <div class="chart-container">
                                    <canvas id="surgeChart"></canvas>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 max-w-lg mx-auto">
                                    <div>
                                        <label for="demandSlider" class="block text-sm font-medium text-slate-700">Rider Demand</label>
                                        <input id="demandSlider" type="range" min="10" max="100" value="50" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                    <div>
                                        <label for="supplySlider" class="block text-sm font-medium text-slate-700">Driver Supply</label>
                                        <input id="supplySlider" type="range" min="10" max="100" value="50" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">4. Schema for Trip Management</h4>
                            <p class="mt-3 text-slate-600">Designing the database schema is crucial for performance and scalability. A mix of SQL and NoSQL databases is often used. For instance, user profiles (Riders, Drivers) can be in a relational database (like PostgreSQL), while trip data, which is write-heavy and has a flexible structure, might be better suited for a NoSQL database (like MongoDB or Cassandra).</p>
                            <p class="mt-2 text-slate-600">Here's a simplified relational schema design:</p>
                            <div class="mt-4 space-y-4">
                                <div class="bg-slate-50 p-4 rounded-lg border">
                                    <p class="font-mono font-semibold text-slate-700">Riders Table</p>
                                    <ul class="font-mono text-sm text-slate-600 list-disc list-inside mt-2">
                                        <li><span class="font-semibold">RiderID</span> (PK, UUID)</li>
                                        <li>Name (VARCHAR)</li>
                                        <li>Email (VARCHAR, UNIQUE)</li>
                                        <li>PhoneNumber (VARCHAR, UNIQUE)</li>
                                        <li>AverageRating (DECIMAL)</li>
                                        <li>CreatedAt (TIMESTAMP)</li>
                                    </ul>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-lg border">
                                    <p class="font-mono font-semibold text-slate-700">Drivers Table</p>
                                    <ul class="font-mono text-sm text-slate-600 list-disc list-inside mt-2">
                                        <li><span class="font-semibold">DriverID</span> (PK, UUID)</li>
                                        <li>Name (VARCHAR)</li>
                                        <li>LicenseNumber (VARCHAR, UNIQUE)</li>
                                        <li>AverageRating (DECIMAL)</li>
                                        <li>Status (ENUM: AVAILABLE, ON_TRIP, OFFLINE)</li>
                                        <li>CurrentLocation (GEOGRAPHY)</li>
                                        <li>CreatedAt (TIMESTAMP)</li>
                                    </ul>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-lg border">
                                    <p class="font-mono font-semibold text-slate-700">Trips Table</p>
                                    <ul class="font-mono text-sm text-slate-600 list-disc list-inside mt-2">
                                        <li><span class="font-semibold">TripID</span> (PK, UUID)</li>
                                        <li>RiderID (FK to Riders)</li>
                                        <li>DriverID (FK to Drivers)</li>
                                        <li>Status (ENUM: REQUESTED, ACCEPTED, ... , COMPLETED)</li>
                                        <li>PickupLocation (GEOGRAPHY)</li>
                                        <li>DropoffLocation (GEOGRAPHY)</li>
                                        <li>Fare (DECIMAL)</li>
                                        <li>RequestedAt (TIMESTAMP)</li>
                                        <li>CompletedAt (TIMESTAMP, NULLABLE)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="uml" class="space-y-8">
                         <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">✅ UML Diagrams: A Visual Deep Dive</h3>
                         <p class="text-slate-600">UML diagrams are essential for understanding system structure and behavior. We'll explore three key types: a Class Diagram for static structure, a Sequence Diagram for dynamic interactions, and a Component Diagram for high-level architecture.</p>
                         
                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend mb-4">1. Class Diagram</h4>
                            <p class="text-slate-600 mb-4">This diagram shows the core classes, their attributes, methods, and the relationships between them (e.g., a Trip is associated with one Rider and one Driver).</p>
                            <div class="overflow-x-auto p-4 bg-slate-50 rounded-lg">
                                <div class="flex gap-8 items-start min-w-[700px]">
                                    <!-- Rider Class -->
                                    <div class="border-2 border-slate-600 rounded-lg bg-white shadow-md">
                                        <div class="font-bold font-mono p-2 bg-slate-200 text-center">Rider</div>
                                        <div class="p-2 border-t border-slate-400 font-mono text-sm">
                                            - id: UUID<br>
                                            - name: string<br>
                                            - rating: double
                                        </div>
                                        <div class="p-2 border-t border-slate-400 font-mono text-sm text-sky-700">
                                            + requestTrip()<br>
                                            + cancelTrip()<br>
                                            + giveRating()
                                        </div>
                                    </div>
                                    
                                    <!-- Trip Class (Center) -->
                                    <div class="border-2 border-slate-600 rounded-lg bg-white shadow-md flex-shrink-0">
                                        <div class="font-bold font-mono p-2 bg-slate-200 text-center">Trip</div>
                                        <div class="p-2 border-t border-slate-400 font-mono text-sm">
                                            - id: UUID<br>
                                            - origin: Location<br>
                                            - destination: Location<br>
                                            - status: TripStatus<br>
                                            - fare: double
                                        </div>
                                        <div class="p-2 border-t border-slate-400 font-mono text-sm text-sky-700">
                                            + updateStatus()<br>
                                            + calculateFare()
                                        </div>
                                    </div>

                                    <!-- Driver Class -->
                                    <div class="border-2 border-slate-600 rounded-lg bg-white shadow-md">
                                        <div class="font-bold font-mono p-2 bg-slate-200 text-center">Driver</div>
                                        <div class="p-2 border-t border-slate-400 font-mono text-sm">
                                            - id: UUID<br>
                                            - name: string<br>
                                            - status: DriverStatus<br>
                                            - currentLocation: Location
                                        </div>
                                        <div class="p-2 border-t border-slate-400 font-mono text-sm text-sky-700">
                                            + acceptTrip()<br>
                                            + updateLocation()<br>
                                            + endTrip()
                                        </div>
                                    </div>
                                    
                                     <!-- Vehicle Class -->
                                    <div class="border-2 border-slate-600 rounded-lg bg-white shadow-md">
                                        <div class="font-bold font-mono p-2 bg-slate-200 text-center">Vehicle</div>
                                        <div class="p-2 border-t border-slate-400 font-mono text-sm">
                                            - licensePlate: string<br>
                                            - model: string<br>
                                            - type: VehicleType
                                        </div>
                                    </div>
                                </div>
                                <!-- Relationships -->
                                <div class="mt-4 text-center font-mono text-sm text-slate-500 min-w-[700px]">
                                    <p>Rider --1..*-- (has) --1-- Trip</p>
                                    <p>Driver --1..*-- (has) --1-- Trip</p>
                                    <p>Driver --1-- (drives) --1-- Vehicle</p>
                                </div>
                            </div>
                         </div>
                         
                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend mb-4">2. Sequence Diagram: Trip Lifecycle (Detailed)</h4>
                            <p class="text-slate-600 mb-4">This detailed diagram shows the precise order of interactions between multiple system components for a single ride request, including asynchronous events like notifications.</p>
                            <div class="overflow-x-auto">
                                <div class="grid grid-cols-5 gap-2 min-w-[800px] text-center text-sm font-semibold">
                                    <div class="bg-sky-100 text-sky-800 p-2 rounded">Rider App</div>
                                    <div class="bg-indigo-100 text-indigo-800 p-2 rounded">Backend API</div>
                                    <div class="bg-emerald-100 text-emerald-800 p-2 rounded">Trip Service</div>
                                    <div class="bg-amber-100 text-amber-800 p-2 rounded">Notification Service</div>
                                    <div class="bg-rose-100 text-rose-800 p-2 rounded">Driver App</div>
                                </div>
                                <div class="grid grid-cols-5 gap-2 min-w-[800px] mt-2">
                                    <div class="border-r-2 border-dashed border-slate-300">&nbsp;</div>
                                    <div class="border-r-2 border-dashed border-slate-300">&nbsp;</div>
                                    <div class="border-r-2 border-dashed border-slate-300">&nbsp;</div>
                                    <div class="border-r-2 border-dashed border-slate-300">&nbsp;</div>
                                    <div>&nbsp;</div>
                                </div>
                                <div class="relative mt-[-2.5rem] space-y-4 text-sm">
                                    <!-- Request -->
                                    <div class="relative h-8"><p class="absolute left-[10%] w-[20%] text-center">1. RequestRide() &#8594;</p></div>
                                    <div class="relative h-8"><p class="absolute left-[30%] w-[20%] text-center">2. CreateTrip() &#8594;</p></div>
                                    <div class="relative h-8"><p class="absolute left-[50%] w-[20%] text-center text-slate-500">3. [async] NotifyDriver() &#8594;</p></div>
                                    <div class="relative h-8"><p class="absolute left-[70%] w-[20%] text-center text-slate-500">4. Push Notification &#8594;</p></div>
                                    <div class="relative h-8"><p class="absolute right-[10%] w-[20%] text-center">&nbsp;</p><p class="text-center font-bold text-slate-400">--- Rider Waits ---</p></div>
                                    <!-- Accept -->
                                    <div class="relative h-8"><p class="absolute right-[10%] w-[20%] text-center">5. AcceptRide() &#8592;</p></div>
                                    <div class="relative h-8"><p class="absolute right-[30%] w-[20%] text-center">6. UpdateTripStatus() &#8592;</p></div>
                                    <div class="relative h-8"><p class="absolute right-[50%] w-[20%] text-center">7. [async] NotifyRider() &#8592;</p></div>
                                    <div class="relative h-8"><p class="absolute left-[10%] w-[20%] text-center text-slate-500">&#8592; 8. Push Notification</p></div>
                                </div>
                            </div>
                         </div>
                         
                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend mb-4">3. Component Diagram</h4>
                             <p class="text-slate-600 mb-4">This high-level diagram shows the main components of our backend, illustrating a microservices architecture. Each component is a self-contained service responsible for a specific business capability.</p>
                             <div class="bg-slate-50 p-4 rounded-lg border">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                    <div class="bg-white p-4 rounded-lg shadow border border-slate-300">
                                        <h5 class="font-semibold text-indigo-700">User Service</h5>
                                        <p class="text-xs text-slate-500 mt-1">Manages Rider/Driver profiles, authentication.</p>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow border border-slate-300">
                                        <h5 class="font-semibold text-indigo-700">Trip Service</h5>
                                        <p class="text-xs text-slate-500 mt-1">Handles trip lifecycle, state management.</p>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow border border-slate-300">
                                        <h5 class="font-semibold text-indigo-700">Matching Service</h5>
                                        <p class="text-xs text-slate-500 mt-1">Finds the best driver for a request.</p>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg shadow border border-slate-300">
                                        <h5 class="font-semibold text-indigo-700">Pricing Service</h5>
                                        <p class="text-xs text-slate-500 mt-1">Calculates fares and handles surge pricing.</p>
                                    </div>
                                     <div class="bg-white p-4 rounded-lg shadow border border-slate-300">
                                        <h5 class="font-semibold text-indigo-700">Notification Service</h5>
                                        <p class="text-xs text-slate-500 mt-1">Sends push notifications, SMS alerts.</p>
                                    </div>
                                     <div class="bg-white p-4 rounded-lg shadow border border-slate-300">
                                        <h5 class="font-semibold text-indigo-700">Payment Service</h5>
                                        <p class="text-xs text-slate-500 mt-1">Integrates with payment gateways.</p>
                                    </div>
                                </div>
                                <div class="text-center text-slate-500 mt-4 text-sm">... all communicating via an <strong>API Gateway</strong> and a <strong>Message Bus</strong> ...</div>
                             </div>
                         </div>
                    </section>
                    
                    <section id="architecture" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">🏛️ System Architecture & Scalability</h3>
                        <p class="text-slate-600">To handle millions of users, the system must be designed for scale from day one. A monolithic application would fail under this load. We adopt a microservices architecture to ensure scalability and resilience.</p>
                        
                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">1. Microservices Architecture</h4>
                            <p class="mt-3 text-slate-600">We break the system down into small, independent services (as shown in the Component Diagram above). Each service has its own database and can be developed, deployed, and scaled independently.</p>
                            <ul class="mt-4 list-disc list-inside space-y-2 text-slate-700">
                                <li><strong>Pros:</strong> Improved scalability (we can scale just the Matching Service during peak hours), better fault isolation (a crash in the Pricing Service doesn't take down trip requests), and technology flexibility (each service can use the best tech for its job).</li>
                                <li><strong>Cons:</strong> Increased operational complexity, challenges in maintaining data consistency across services, and more complex debugging.</li>
                            </ul>
                        </div>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">2. Asynchronous Communication with Message Queues</h4>
                            <p class="mt-3 text-slate-600">Many actions in our system don't need to happen instantly. For example, when a trip is completed, we need to process payment, notify the rider, and update the driver's earnings. Doing this synchronously would make the "End Trip" API call very slow.</p>
                            <p class="mt-2 text-slate-600">Instead, we use a <strong>Message Queue</strong> (like RabbitMQ or Kafka). When the trip ends, the Trip Service publishes a `TripCompleted` event to the queue. Other services (Payment, Notification, etc.) subscribe to this event and process it asynchronously in the background. This makes the system more resilient and responsive.</p>
                            <div class="font-mono bg-slate-100 p-4 rounded-lg text-slate-800 mt-4 text-sm">
                                <strong>Trip Service:</strong> Publishes `Event: TripCompleted(tripId, driverId, riderId, fare)`<br>
                                <strong>Payment Service:</strong> Subscribes, processes payment.<br>
                                <strong>Notification Service:</strong> Subscribes, sends receipt.<br>
                                <strong>Driver Service:</strong> Subscribes, updates driver's earnings.
                            </div>
                        </div>
                    </section>

                    <section id="coding" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">✅ Coding Practice: C# Implementation</h3>
                        <p class="text-slate-600">Now, let's translate theory into practice. We'll use C# to model our core entities and implement the main functionalities. The code is structured to be clear and extensible.</p>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">Core Classes: Rider, Driver, Trip</h4>
                            <p class="mt-3 text-slate-600">First, we define the Plain Old C# Object (POCO) classes that represent our main entities. These classes will hold the state for each object in our system.</p>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
public class Location
{
    public double Latitude { get; set; }
    public double Longitude { get; set; }
}

public enum UserStatus { Active, Inactive }
public enum DriverStatus { Available, OnTrip, Offline }
public enum TripStatus { Requested, Accepted, InProgress, Completed, Cancelled }

public class Rider
{
    public Guid Id { get; private set; } = Guid.NewGuid();
    public string Name { get; set; }
    public UserStatus Status { get; set; } = UserStatus.Active;
    public double AverageRating { get; private set; }
}

public class Driver
{
    public Guid Id { get; private set; } = Guid.NewGuid();
    public string Name { get; set; }
    public DriverStatus Status { get; set; } = DriverStatus.Offline;
    public double AverageRating { get; private set; }
    public Location CurrentLocation { get; set; }
}

public class Trip
{
    public Guid Id { get; private set; } = Guid.NewGuid();
    public Guid RiderId { get; set; }
    public Guid? DriverId { get; set; }
    public Location Origin { get; set; }
    public Location Destination { get; set; }
    public TripStatus Status { get; set; }
    public double Fare { get; set; }
    public DateTime RequestedAt { get; private set; } = DateTime.UtcNow;
    public DateTime? CompletedAt { get; set; }
}
                                </code></pre>
                            </div>
                        </div>

                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">[Easy] Register Rider & Driver</h4>
                            <p class="mt-3 text-slate-600">We need a way to manage our users. A manager class is a good pattern for this. It will hold our "database" of riders and drivers in memory for this example and provide methods to add new ones.</p>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
using System.Collections.Concurrent;

public class UserManager
{
    private readonly ConcurrentDictionary&lt;Guid, Rider&gt; riders = new();
    private readonly ConcurrentDictionary&lt;Guid, Driver&gt; drivers = new();

    public Rider RegisterRider(string name)
    {
        var rider = new Rider { Name = name };
        riders.TryAdd(rider.Id, rider);
        Console.WriteLine($"Rider '{name}' registered with ID: {rider.Id}");
        return rider;
    }

    public Driver RegisterDriver(string name, Location initialLocation)
    {
        var driver = new Driver { Name = name, CurrentLocation = initialLocation, Status = DriverStatus.Available };
        drivers.TryAdd(driver.Id, driver);
        Console.WriteLine($"Driver '{name}' registered at ({initialLocation.Latitude}, {initialLocation.Longitude})");
        return driver;
    }

    public Rider GetRider(Guid id) => riders.GetValueOrDefault(id);
    public Driver GetDriver(Guid id) => drivers.GetValueOrDefault(id);
    public IEnumerable&lt;Driver&gt; GetAvailableDrivers() => drivers.Values.Where(d => d.Status == DriverStatus.Available);
}
                                </code></pre>
                            </div>
                        </div>

                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">[Medium] Assign Nearest Driver</h4>
                            <p class="mt-3 text-slate-600">This is the core of our matching logic. The `TripManager` will be responsible for creating trips and finding a suitable driver. For simplicity, we'll use Euclidean distance, but in a real system, you'd use the Haversine formula and a mapping API for ETAs.</p>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
public static class DistanceCalculator
{
    // Simple Euclidean distance for demo purposes.
    // Real-world: Use Haversine formula and mapping APIs.
    public static double CalculateDistance(Location loc1, Location loc2)
    {
        double dx = loc1.Latitude - loc2.Latitude;
        double dy = loc1.Longitude - loc2.Longitude;
        return Math.Sqrt(dx * dx + dy * dy);
    }
}

public class TripManager
{
    private readonly ConcurrentDictionary&lt;Guid, Trip&gt; trips = new();
    private readonly UserManager userManager;
    private readonly PricingManager pricingManager;

    public TripManager(UserManager userManager, PricingManager pricingManager)
    {
        this.userManager = userManager;
        this.pricingManager = pricingManager;
    }

    public Trip RequestTrip(Guid riderId, Location origin, Location destination)
    {
        var rider = userManager.GetRider(riderId);
        if (rider == null)
        {
            Console.WriteLine("Invalid rider ID.");
            return null;
        }

        var availableDrivers = userManager.GetAvailableDrivers().ToList();
        if (!availableDrivers.Any())
        {
            Console.WriteLine("No available drivers at the moment.");
            return null;
        }

        // Find the nearest driver
        Driver nearestDriver = availableDrivers
            .OrderBy(driver => DistanceCalculator.CalculateDistance(driver.CurrentLocation, origin))
            .FirstOrDefault();
        
        if (nearestDriver == null) {
             Console.WriteLine("Could not find a suitable driver.");
             return null;
        }

        // Create the trip
        var fare = pricingManager.CalculateFare(origin, destination);
        var trip = new Trip
        {
            RiderId = riderId,
            DriverId = nearestDriver.Id,
            Origin = origin,
            Destination = destination,
            Status = TripStatus.Accepted,
            Fare = fare
        };

        trips.TryAdd(trip.Id, trip);
        
        nearestDriver.Status = DriverStatus.OnTrip;

        Console.WriteLine($"Trip {trip.Id} created. Driver {nearestDriver.Name} assigned to Rider {rider.Name}. Fare: ${fare:F2}");
        return trip;
    }
}
                                </code></pre>
                            </div>
                        </div>

                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">[Hard] Handle Surge Pricing with Concurrency</h4>
                            <p class="mt-3 text-slate-600">Surge pricing requires real-time analysis of supply and demand. The system must be thread-safe, as many requests and driver status updates can happen concurrently. We'll use a `ConcurrentDictionary` to track demand and supply in different zones and a `Timer` to periodically update the surge multiplier.</p>
                             <blockquote class="mt-4 border-l-4 border-amber-400 bg-amber-50 p-4 text-amber-800 rounded-r-lg">
                                <strong>Concurrency Challenge</strong>
                                <p class="text-sm mt-1">The main challenge here is avoiding race conditions. If we read the supply/demand counts, calculate a multiplier, and then write it back, another thread could have changed the counts in between. Using locks or thread-safe collections like `ConcurrentDictionary` is essential to ensure data consistency.</p>
                            </blockquote>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
public class PricingManager
{
    private const double BaseFare = 2.50;
    private const double PerKmRate = 1.50;
    private static readonly ConcurrentDictionary&lt;int, double&gt; surgeMultipliersByZone = new();
    private static readonly ConcurrentDictionary&lt;int, int&gt; riderRequestsByZone = new();
    private static readonly ConcurrentDictionary&lt;int, int&gt; availableDriversByZone = new();
    private Timer surgeUpdateTimer;

    public PricingManager()
    {
        // Update surge prices every 30 seconds
        surgeUpdateTimer = new Timer(UpdateSurgeMultipliers, null, 0, 30000);
    }

    public double CalculateFare(Location origin, Location destination)
    {
        double distance = DistanceCalculator.CalculateDistance(origin, destination) * 10; // Mock distance
        int zone = GetZone(origin);
        double multiplier = surgeMultipliersByZone.GetOrAdd(zone, 1.0);
        
        return (BaseFare + (distance * PerKmRate)) * multiplier;
    }

    private void UpdateSurgeMultipliers(object state)
    {
        Console.WriteLine("\nUpdating surge multipliers...");
        foreach (var zone in riderRequestsByZone.Keys.Union(availableDriversByZone.Keys))
        {
            int demand = riderRequestsByZone.GetOrAdd(zone, 0);
            int supply = availableDriversByZone.GetOrAdd(zone, 1); // Avoid division by zero

            double ratio = (double)demand / supply;
            double newMultiplier = 1.0;

            if (ratio > 5) newMultiplier = 2.0;
            else if (ratio > 3) newMultiplier = 1.5;
            else if (ratio > 2) newMultiplier = 1.2;

            surgeMultipliersByZone[zone] = newMultiplier;
            Console.WriteLine($"Zone {zone}: Demand={demand}, Supply={supply}, New Multiplier={newMultiplier:F1}x");
        }
        // Reset counts for the next window
        riderRequestsByZone.Clear();
        availableDriversByZone.Clear();
    }

    // This would be called whenever a rider requests or a driver changes status
    public void LogDemand(Location location) => riderRequestsByZone.AddOrUpdate(GetZone(location), 1, (key, count) => count + 1);
    public void LogSupply(Location location) => availableDriversByZone.AddOrUpdate(GetZone(location), 1, (key, count) => count + 1);
    
    // Simple zoning based on integer parts of lat/lon
    private int GetZone(Location location) => (int)location.Latitude + (int)location.Longitude;
}
                                </code></pre>
                            </div>
                        </div>
                    </section>

                    <section id="case-study" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">✅ Case Study: Build Ride-Hailing Backend Service</h3>
                        <p class="text-slate-600">Let's put all the pieces together into a runnable console application. This simulation will register users, have them request rides in parallel to test our concurrency handling, and show the system in action.</p>
                        <div class="code-block mt-4">
                            <button class="copy-btn">Copy</button>
                            <pre class="bg-slate-900 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
// Main Program to run the simulation
public class RideHailingSimulation
{
    public static async Task Main(string[] args)
    {
        var userManager = new UserManager();
        var pricingManager = new PricingManager();
        var tripManager = new TripManager(userManager, pricingManager);
        var random = new Random();

        Console.WriteLine("--- Ride-Hailing Service Simulation ---");

        // Register drivers
        var driver1 = userManager.RegisterDriver("Alice", new Location { Latitude = 10.1, Longitude = 10.1 });
        var driver2 = userManager.RegisterDriver("Bob", new Location { Latitude = 10.5, Longitude = 10.5 });
        var driver3 = userManager.RegisterDriver("Charlie", new Location { Latitude = 11.0, Longitude = 11.0 });

        // Register riders
        var rider1 = userManager.RegisterRider("Dave");
        var rider2 = userManager.RegisterRider("Eve");
        var rider3 = userManager.RegisterRider("Frank");
        
        Console.WriteLine("\n--- Simulating High Demand Period ---");
        
        // Simulate high demand in a specific zone
        for(int i = 0; i < 15; i++) {
             pricingManager.LogDemand(new Location { Latitude = 10.2, Longitude = 10.2 });
        }
        // Log available drivers
        pricingManager.LogSupply(driver1.CurrentLocation);
        pricingManager.LogSupply(driver2.CurrentLocation);
        pricingManager.LogSupply(driver3.CurrentLocation);

        // Wait for surge update
        await Task.Delay(1000); 

        Console.WriteLine("\n--- Simulating Concurrent Ride Requests ---");

        // Use Task.WhenAll to simulate concurrent requests
        var requestTasks = new List&lt;Task&gt;
        {
            Task.Run(() => tripManager.RequestTrip(rider1.Id, new Location { Latitude = 10.2, Longitude = 10.2 }, new Location { Latitude = 12.0, Longitude = 12.0 })),
            Task.Run(() => tripManager.RequestTrip(rider2.Id, new Location { Latitude = 10.6, Longitude = 10.6 }, new Location { Latitude = 13.0, Longitude = 13.0 })),
            Task.Run(() => tripManager.RequestTrip(rider3.Id, new Location { Latitude = 10.8, Longitude = 10.8 }, new Location { Latitude = 14.0, Longitude = 14.0 }))
        };

        await Task.WhenAll(requestTasks);
        
        Console.WriteLine("\n--- Simulation Complete ---");
    }
}
// To run this: Place all classes (Location, Rider, etc.) in the same file or project and run the Main method.
                            </code></pre>
                        </div>
                    </section>

                    <section id="quiz" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">🧠 Enhanced Knowledge Check</h3>
                        <p class="text-slate-600">Test your understanding of the core concepts of ride-hailing backend design.</p>
                        <div id="quiz-container" class="space-y-6"></div>
                    </section>

                    <section id="challenge" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">🏆 Self-Assessment Challenge</h3>
                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-lg font-semibold text-slate-800">Challenge: Implement Driver Ratings</h4>
                            <p class="mt-3 text-slate-600">Extend the current system to allow riders to rate drivers after a trip is completed. Consider the following:</p>
                            <ul class="mt-4 list-disc list-inside space-y-2 text-slate-700">
                                <li>Add a `RateDriver(Guid tripId, int rating)` method to the `TripManager`.</li>
                                <li>The rating should be between 1 and 5.</li>
                                <li>When a driver is rated, their `AverageRating` in the `Driver` class should be updated. How would you calculate the new average efficiently without storing all previous ratings?</li>
                                <li>Ensure that a trip can only be rated once and only after it is `COMPLETED`.</li>
                            </ul>
                            <button id="toggleSolutionBtn" class="mt-6 bg-slate-200 text-slate-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors shadow-sm">Show Solution</button>
                            <div id="solution" class="hidden mt-4 border-t pt-4">
                                <p class="text-slate-600">To calculate the new average rating efficiently, you need to store the total number of ratings along with the average. Let's say a driver has an `AverageRating` of 4.5 from `TotalRatings` of 100. The total sum of ratings is `4.5 * 100 = 450`. When a new rating of 5 comes in, the new sum is `450 + 5 = 455`, and the new total ratings count is 101. The new average is `455 / 101 = 4.505`.</p>
                                <div class="code-block mt-4">
                                    <button class="copy-btn">Copy</button>
                                    <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
// Add to Driver class:
public int TotalRatings { get; private set; } = 0;
private double _totalRatingSum = 0.0;

public void UpdateRating(int newRating)
{
    if (newRating < 1 || newRating > 5) return;
    _totalRatingSum += newRating;
    TotalRatings++;
    AverageRating = _totalRatingSum / TotalRatings;
}

// Add to TripManager class:
public void RateDriver(Guid tripId, int rating)
{
    if (!trips.TryGetValue(tripId, out var trip))
    {
        Console.WriteLine("Invalid Trip ID.");
        return;
    }

    if (trip.Status != TripStatus.Completed)
    {
        Console.WriteLine("Can only rate completed trips.");
        return;
    }
    
    if (trip.DriverId == null) return;
    
    var driver = userManager.GetDriver(trip.DriverId.Value);
    if (driver != null)
    {
        driver.UpdateRating(rating);
        Console.WriteLine($"Driver {driver.Name} new rating is {driver.AverageRating:F2} from {driver.TotalRatings} ratings.");
    }
}
                                    </code></pre>
                                </div>
                            </div>
                        </div>
                    </section>

                </article>
            </div>

            <aside class="lg:w-1/4 lg:sticky top-8 self-start">
                <div class="p-6 bg-white rounded-xl shadow-sm">
                            <div id="toc" class="mt-4">
                        <ul class="space-y-2">
                            <li><a href="#theory" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Theory Topics</a></li>
                            <li><a href="#uml" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">UML Diagrams</a></li>
                            <li><a href="#architecture" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">System Architecture</a></li>
                            <li><a href="#coding" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Coding Practice</a></li>
                            <li><a href="#case-study" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Case Study</a></li>
                            <li><a href="#quiz" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Knowledge Check</a></li>
                            <li><a href="#challenge" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Self-Assessment Challenge</a></li>
                        </ul>
                    </nav>
                </div>
            </aside>
        </div>
    </main>

    <footer class="text-center mt-16 py-8 border-t border-slate-200">
        <p class="text-slate-700 font-semibold">Low-Level Design Bootcamp</p>
        <p class="text-sm text-slate-500 mt-2">A personalized learning roadmap curated by Mr. Mahesh Singare.</p>
        <p class="text-xs text-slate-400 mt-4">&copy; 2025. All Rights Reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- Matching Canvas ---
            const canvas = document.getElementById('matchingCanvas');
            const ctx = canvas.getContext('2d');
            const findDriverBtn = document.getElementById('findDriverBtn');
            let rider = { x: 0, y: 0 };
            let drivers = [];

            function resizeCanvas() {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                resetAndDraw();
            }

            function resetAndDraw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                rider = { x: canvas.width * 0.2, y: canvas.height * 0.5 };
                drivers = [
                    { x: canvas.width * 0.5, y: canvas.height * 0.2, name: 'D1' },
                    { x: canvas.width * 0.8, y: canvas.height * 0.4, name: 'D2' },
                    { x: canvas.width * 0.6, y: canvas.height * 0.8, name: 'D3' },
                    { x: canvas.width * 0.3, y: canvas.height * 0.3, name: 'D4' },
                ];
                
                // Draw Rider
                ctx.beginPath();
                ctx.arc(rider.x, rider.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#0ea5e9';
                ctx.fill();
                ctx.closePath();
                ctx.font = '12px Inter';
                ctx.fillStyle = '#0c4a6e';
                ctx.fillText('Rider', rider.x - 15, rider.y + 20);

                // Draw Drivers
                drivers.forEach(driver => {
                    ctx.beginPath();
                    ctx.arc(driver.x, driver.y, 6, 0, Math.PI * 2);
                    ctx.fillStyle = '#f59e0b';
                    ctx.fill();
                    ctx.closePath();
                    ctx.fillStyle = '#78350f';
                    ctx.fillText(driver.name, driver.x - 5, driver.y - 10);
                });
            }

            findDriverBtn.addEventListener('click', () => {
                resetAndDraw();
                let nearestDriver = null;
                let minDistance = Infinity;

                drivers.forEach(driver => {
                    const dist = Math.sqrt(Math.pow(rider.x - driver.x, 2) + Math.pow(rider.y - driver.y, 2));
                    if (dist < minDistance) {
                        minDistance = dist;
                        nearestDriver = driver;
                    }
                });

                if (nearestDriver) {
                    // Highlight nearest
                    ctx.beginPath();
                    ctx.arc(nearestDriver.x, nearestDriver.y, 8, 0, Math.PI * 2);
                    ctx.strokeStyle = '#22c55e';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    ctx.closePath();
                    
                    // Draw line
                    ctx.beginPath();
                    ctx.moveTo(rider.x, rider.y);
                    ctx.lineTo(nearestDriver.x, nearestDriver.y);
                    ctx.strokeStyle = '#64748b';
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.closePath();
                }
            });
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // --- Surge Chart ---
            const surgeCtx = document.getElementById('surgeChart').getContext('2d');
            const demandSlider = document.getElementById('demandSlider');
            const supplySlider = document.getElementById('supplySlider');

            const surgeChart = new Chart(surgeCtx, {
                type: 'bar',
                data: {
                    labels: ['Surge Multiplier'],
                    datasets: [{
                        label: 'Price Multiplier',
                        data: [1],
                        backgroundColor: ['#38bdf8'],
                        borderColor: ['#0284c7'],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 3.0,
                            title: {
                                display: true,
                                text: 'Multiplier (e.g., 1.5x)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    return `Multiplier: ${context.raw.toFixed(1)}x`;
                                }
                            }
                        }
                    }
                }
            });

            function updateSurgeChart() {
                const demand = parseInt(demandSlider.value);
                const supply = parseInt(supplySlider.value);
                const ratio = demand / Math.max(1, supply);

                let multiplier = 1.0;
                let color = '#38bdf8';

                if (ratio > 5) {
                    multiplier = 2.5;
                    color = '#ef4444';
                } else if (ratio > 3) {
                    multiplier = 2.0;
                    color = '#f97316';
                } else if (ratio > 1.5) {
                    multiplier = 1.5;
                    color = '#f59e0b';
                }
                
                surgeChart.data.datasets[0].data[0] = multiplier;
                surgeChart.data.datasets[0].backgroundColor[0] = color;
                surgeChart.data.datasets[0].borderColor[0] = color;
                surgeChart.update();
            }

            demandSlider.addEventListener('input', updateSurgeChart);
            supplySlider.addEventListener('input', updateSurgeChart);
            updateSurgeChart();


            // --- TOC Active State ---
            const sections = document.querySelectorAll('section[id]');
            const tocLinks = document.querySelectorAll('#toc a');
            
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        tocLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href') === `#${id}`) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, { rootMargin: '-50% 0px -50% 0px' });

            sections.forEach(section => observer.observe(section));


            // --- Copy to Clipboard ---
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const code = button.nextElementSibling.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        button.innerText = 'Copied!';
                        setTimeout(() => { button.innerText = 'Copy'; }, 2000);
                    });
                });
            });

            // --- Quiz Logic ---
            const quizData = [
                {
                    question: "What is the primary goal of the driver-rider matching algorithm?",
                    options: ["To find the driver with the highest rating", "To minimize the rider's wait time and driver's pickup travel time", "To maximize the fare for the company", "To assign the driver who has been waiting the longest"],
                    answer: "To minimize the rider's wait time and driver's pickup travel time"
                },
                {
                    question: "What is the main economic purpose of surge pricing?",
                    options: ["To punish riders for requesting during busy times", "To give drivers a random bonus", "To balance supply (drivers) and demand (riders)", "To make rides more expensive than taxis"],
                    answer: "To balance supply (drivers) and demand (riders)"
                },
                 {
                    question: "Which data structure is most suitable for handling concurrent updates to driver locations and statuses in C#?",
                    options: ["List<T>", "Dictionary<K,V>", "ConcurrentDictionary<K,V>", "Array"],
                    answer: "ConcurrentDictionary<K,V>"
                },
                {
                    question: "In a sequence diagram for a ride request, what is the first component the 'Backend Service' typically communicates with?",
                    options: ["Payment Gateway", "Driver App", "Rider App", "Matching Service"],
                    answer: "Matching Service"
                }
            ];

            const quizContainer = document.getElementById('quiz-container');
            quizData.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'p-6 bg-white rounded-xl shadow-sm';
                questionEl.innerHTML = `
                    <p class="font-semibold text-slate-800">${index + 1}. ${q.question}</p>
                    <div class="mt-4 space-y-3" id="options-${index}">
                        ${q.options.map((opt, i) => `<div data-answer="${opt}" class="quiz-option cursor-pointer p-3 border-2 border-slate-200 rounded-lg hover:bg-slate-100 hover:border-sky-300">${opt}</div>`).join('')}
                    </div>
                    <p id="feedback-${index}" class="mt-3 text-sm font-semibold hidden"></p>
                `;
                quizContainer.appendChild(questionEl);

                document.getElementById(`options-${index}`).addEventListener('click', (e) => {
                    const selectedOption = e.target.closest('.quiz-option');
                    if (!selectedOption) return;

                    const isCorrect = selectedOption.dataset.answer === q.answer;
                    const feedbackEl = document.getElementById(`feedback-${index}`);

                    Array.from(selectedOption.parentElement.children).forEach(child => {
                        child.classList.remove('correct', 'incorrect');
                        child.style.pointerEvents = 'none'; 
                    });

                    selectedOption.classList.add(isCorrect ? 'correct' : 'incorrect');
                    feedbackEl.textContent = isCorrect ? 'Correct!' : `Incorrect. The correct answer is: ${q.answer}`;
                    feedbackEl.className = `mt-3 text-sm font-semibold ${isCorrect ? 'text-green-600' : 'text-red-600'}`;
                    feedbackEl.classList.remove('hidden');
                });
            });


            // --- Solution Toggler ---
            const toggleSolutionBtn = document.getElementById('toggleSolutionBtn');
            const solutionDiv = document.getElementById('solution');
            toggleSolutionBtn.addEventListener('click', () => {
                const isHidden = solutionDiv.classList.contains('hidden');
                solutionDiv.classList.toggle('hidden');
                toggleSolutionBtn.textContent = isHidden ? 'Hide Solution' : 'Show Solution';
            });
        });
    </script>
</body>
</html>

