<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 58: Ride-Hailing Backend (Uber/Ola) | LLD Bootcamp</title>
    <!-- Chosen Palette: Slate & Sky -->
    <!-- Application Structure Plan: A two-column layout with a sticky ToC on the right for navigation and the main learning content on the left. The structure is a linear, progressive learning path: starting with foundational theory, moving to visual flow diagrams (UML), then practical coding exercises of increasing difficulty, a full case study, and finally knowledge reinforcement through a quiz and a self-assessment challenge. This sequential structure is chosen to build knowledge systematically, making complex topics digestible for a bootcamp student. -->
    <!-- Visualization & Content Choices: Report Info: Rider-Driver Matching -> Goal: Illustrate proximity -> Viz: Interactive Canvas with dots representing users -> Interaction: Button click calculates and highlights the nearest driver -> Justification: Provides a tangible, visual understanding of the core algorithm. Report Info: Surge Pricing -> Goal: Explain dynamic pricing -> Viz: Bar chart (Chart.js) -> Interaction: Sliders for demand/supply update the price multiplier on the chart -> Justification: Clearly demonstrates the cause-and-effect relationship in real-time. Report Info: Trip Sequence -> Goal: Show process flow -> Viz: HTML/CSS diagram -> Interaction: Hover effects on steps for more info -> Justification: A clear, static-but-interactive visualization of the system's logic without complex libraries. All code is presented in styled blocks with copy-to-clipboard functionality for ease of use. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .font-lexend {
            font-family: 'Lexend', sans-serif;
        }
        .toc-link.active {
            color: #0ea5e9;
            border-left-color: #0ea5e9;
            font-weight: 600;
        }
        .code-block {
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
            background-color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .copy-btn:hover {
            background-color: #cbd5e1;
            color: #1e293b;
        }
        .quiz-option {
            transition: all 0.2s ease-in-out;
        }
        .quiz-option.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }
        .quiz-option.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="bg-slate-100/80 border-b border-slate-200">
        <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 relative">
            <header class="text-center">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-800 mt-1 tracking-tight font-lexend">Low-Level Design Bootcamp</h1>
                <p class="mt-3 text-slate-600 max-w-xl mx-auto">Your 60-Day Interactive Roadmap to Mastering Backend Engineering.</p>
            </header>
             <a href="roadmap.html?week=9" class="absolute top-1/2 -translate-y-1/2 right-4 sm:right-6 lg:right-8 bg-slate-200 text-slate-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors shadow-sm">
                Return to Homepage
            </a>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div class="flex flex-col lg:flex-row gap-12">

            <div class="lg:w-3/4">
                <article class="space-y-12">
                    <header>
                        <p class="text-sm font-semibold text-sky-600">Day 58: Final Case Studies</p>
                        <h2 class="text-3xl sm:text-4xl font-extrabold text-slate-900 mt-2 tracking-tight font-lexend">Ride-Hailing Backend Service (Uber/Ola)</h2>
                        <p class="mt-4 text-lg text-slate-600">This lesson dives deep into the architecture of a ride-hailing service. We'll deconstruct the system into its core components, explore the critical algorithms for matching and pricing, and design a robust backend capable of handling real-world complexity, including concurrency and scalability.</p>
                    </header>

                    <section id="theory" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">✅ Theory Topics: The Architectural Blueprint</h3>
                        
                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">1. Core System Requirements</h4>
                            <p class="mt-3 text-slate-600">At its heart, a ride-hailing service is a three-sided marketplace connecting Riders, Drivers, and the Platform. The system must manage the lifecycle of a trip from request to completion. Let's break down the primary actors and entities:</p>
                            <ul class="mt-4 list-disc list-inside space-y-2 text-slate-700">
                                <li><strong>Riders:</strong> Users who request rides. Key attributes include `UserID`, `Name`, `Rating`, `CurrentLocation`, and `PaymentInfo`. They need to be able to request a ride, see fare estimates, track driver location, and rate drivers.</li>
                                <li><strong>Drivers:</strong> Individuals who provide the ride service. Key attributes include `DriverID`, `Name`, `Rating`, `CurrentLocation`, `VehicleDetails`, and `IsAvailable` status. They need to accept/reject ride requests, navigate, and see earnings.</li>
                                <li><strong>Trips:</strong> The central entity that links a rider and a driver for a journey. It encapsulates the entire process. Key attributes include `TripID`, `RiderID`, `DriverID`, `Origin`, `Destination`, `Status` (e.g., REQUESTED, ACCEPTED, IN_PROGRESS, COMPLETED, CANCELLED), `Fare`, and `Route`.</li>
                            </ul>
                        </div>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">2. The Matching Algorithm: Connecting Rider & Driver</h4>
                            <p class="mt-3 text-slate-600">The "magic" of a ride-hailing app is its ability to efficiently match a rider with the best possible driver. This isn't just about finding the *closest* driver; it involves a complex set of factors. The primary goal is to minimize the rider's wait time and the driver's travel time to the pickup location.</p>
                            <p class="mt-2 text-slate-600">The process typically follows these steps:</p>
                            <ol class="mt-4 list-decimal list-inside space-y-2 text-slate-700">
                                <li>A rider requests a ride from a specific location.</li>
                                <li>The system identifies a pool of available drivers within a certain radius (e.g., 5 km). This is a spatial query, often optimized using techniques like Geohashing or Quadtrees to avoid scanning all drivers in the database.</li>
                                <li>For each driver in the pool, the system calculates the Estimated Time of Arrival (ETA) to the rider's pickup location. This uses real-time traffic data from services like Google Maps or Waze.</li>
                                <li>The system then ranks the drivers based on factors like ETA (lowest is best), driver rating (higher is better), and vehicle type.</li>
                                <li>The request is sent to the top-ranked driver. If they don't accept within a short time frame (e.g., 15-30 seconds), the request is sent to the next driver in the list, and so on.</li>
                            </ol>
                            <blockquote class="mt-4 border-l-4 border-sky-400 bg-sky-50 p-4 text-sky-800 rounded-r-lg">
                                <strong>Deep Dive: The Haversine Formula</strong>
                                <p class="text-sm mt-1">To calculate the straight-line "as-the-crow-flies" distance between two geographical points (latitude/longitude), the Haversine formula is commonly used. While real-world ETAs depend on road networks and traffic, Haversine provides a quick, computationally cheap way to filter for the closest drivers initially before running more expensive ETA calculations.</p>
                            </blockquote>
                            <div class="mt-6">
                                <h5 class="font-semibold text-center text-slate-700">Interactive Matching Demo</h5>
                                <p class="text-sm text-center text-slate-500 mb-2">Click the button to find the nearest driver to the rider.</p>
                                <canvas id="matchingCanvas" class="bg-slate-50 border rounded-lg w-full h-64 mx-auto block max-w-md"></canvas>
                                <div class="text-center mt-3">
                                    <button id="findDriverBtn" class="bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 transition-colors shadow-sm">Find Nearest Driver</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">3. Pricing Model & Surge Pricing</h4>
                            <p class="mt-3 text-slate-600">Pricing is dynamic and calculated based on several factors:</p>
                            <ul class="mt-4 list-disc list-inside space-y-2 text-slate-700">
                                <li><strong>Base Fare:</strong> A flat fee for starting a trip.</li>
                                <li><strong>Per-Kilometer Rate:</strong> A charge based on the distance of the trip.</li>
                                <li><strong>Per-Minute Rate:</strong> A charge based on the duration of the trip (to account for traffic).</li>
                                <li><strong>Booking Fee/Taxes:</strong> Additional platform fees and government taxes.</li>
                            </ul>
                            <h5 class="mt-6 text-lg font-semibold text-slate-800">Surge Pricing: Balancing Supply and Demand</h5>
                            <p class="mt-2 text-slate-600">Surge pricing is a mechanism to dynamically adjust prices to match supply (available drivers) with demand (riders requesting rides) in a specific geographical area. When demand outstrips supply (e.g., during rush hour, bad weather, or after a major event), prices increase. This has two effects:</p>
                            <ol class="mt-4 list-decimal list-inside space-y-2 text-slate-700">
                                <li>It incentivizes more drivers to come online or travel to the high-demand area.</li>
                                <li>It reduces demand, as some riders may choose to wait or find alternative transport.</li>
                            </ol>
                            <p class="mt-3 text-slate-600">The system continuously monitors the ratio of available drivers to rider requests in different zones. If this ratio falls below a certain threshold, a surge multiplier (e.g., 1.2x, 1.5x, 2.0x) is applied to the standard fare.</p>
                             <div class="mt-6">
                                <h5 class="font-semibold text-center text-slate-700">Interactive Surge Pricing Simulator</h5>
                                <p class="text-sm text-center text-slate-500 mb-2">Adjust the sliders to see how supply and demand affect the price multiplier.</p>
                                <div class="chart-container">
                                    <canvas id="surgeChart"></canvas>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 max-w-lg mx-auto">
                                    <div>
                                        <label for="demandSlider" class="block text-sm font-medium text-slate-700">Rider Demand</label>
                                        <input id="demandSlider" type="range" min="10" max="100" value="50" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                    <div>
                                        <label for="supplySlider" class="block text-sm font-medium text-slate-700">Driver Supply</label>
                                        <input id="supplySlider" type="range" min="10" max="100" value="50" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">4. Schema for Trip Management</h4>
                            <p class="mt-3 text-slate-600">Designing the database schema is crucial for performance and scalability. A mix of SQL and NoSQL databases is often used. For instance, user profiles (Riders, Drivers) can be in a relational database (like PostgreSQL), while trip data, which is write-heavy and has a flexible structure, might be better suited for a NoSQL database (like MongoDB or Cassandra).</p>
                            <p class="mt-2 text-slate-600">Here's a simplified relational schema design:</p>
                            <div class="mt-4 space-y-4">
                                <div class="bg-slate-50 p-4 rounded-lg border">
                                    <p class="font-mono font-semibold text-slate-700">Riders Table</p>
                                    <ul class="font-mono text-sm text-slate-600 list-disc list-inside mt-2">
                                        <li><span class="font-semibold">RiderID</span> (PK, UUID)</li>
                                        <li>Name (VARCHAR)</li>
                                        <li>Email (VARCHAR, UNIQUE)</li>
                                        <li>PhoneNumber (VARCHAR, UNIQUE)</li>
                                        <li>AverageRating (DECIMAL)</li>
                                        <li>CreatedAt (TIMESTAMP)</li>
                                    </ul>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-lg border">
                                    <p class="font-mono font-semibold text-slate-700">Drivers Table</p>
                                    <ul class="font-mono text-sm text-slate-600 list-disc list-inside mt-2">
                                        <li><span class="font-semibold">DriverID</span> (PK, UUID)</li>
                                        <li>Name (VARCHAR)</li>
                                        <li>LicenseNumber (VARCHAR, UNIQUE)</li>
                                        <li>AverageRating (DECIMAL)</li>
                                        <li>Status (ENUM: AVAILABLE, ON_TRIP, OFFLINE)</li>
                                        <li>CurrentLocation (GEOGRAPHY)</li>
                                        <li>CreatedAt (TIMESTAMP)</li>
                                    </ul>
                                </div>
                                <div class="bg-slate-50 p-4 rounded-lg border">
                                    <p class="font-mono font-semibold text-slate-700">Trips Table</p>
                                    <ul class="font-mono text-sm text-slate-600 list-disc list-inside mt-2">
                                        <li><span class="font-semibold">TripID</span> (PK, UUID)</li>
                                        <li>RiderID (FK to Riders)</li>
                                        <li>DriverID (FK to Drivers)</li>
                                        <li>Status (ENUM: REQUESTED, ACCEPTED, ... , COMPLETED)</li>
                                        <li>PickupLocation (GEOGRAPHY)</li>
                                        <li>DropoffLocation (GEOGRAPHY)</li>
                                        <li>Fare (DECIMAL)</li>
                                        <li>RequestedAt (TIMESTAMP)</li>
                                        <li>CompletedAt (TIMESTAMP, NULLABLE)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="uml" class="space-y-8">
                         <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">✅ UML/Schema Task: Visualizing the Ride Request Flow</h3>
                         <p class="text-slate-600">A sequence diagram is perfect for visualizing the interactions between different components of the system over time. It clearly shows the order of operations for a key process like requesting a ride. This helps in understanding dependencies and potential bottlenecks.</p>
                         <div class="p-6 bg-white rounded-xl shadow-sm overflow-x-auto">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend mb-4">Sequence Diagram: Trip Lifecycle</h4>
                            <div class="flex gap-4 min-w-[600px]">
                                <div class="w-1/4 text-center">
                                    <div class="bg-sky-100 text-sky-800 font-semibold p-2 rounded-lg">Rider App</div>
                                    <div class="h-full border-l-2 border-dashed border-slate-400 mx-auto w-0 mt-2"></div>
                                </div>
                                <div class="w-1/4 text-center">
                                    <div class="bg-indigo-100 text-indigo-800 font-semibold p-2 rounded-lg">Backend Service</div>
                                    <div class="h-full border-l-2 border-dashed border-slate-400 mx-auto w-0 mt-2"></div>
                                </div>
                                <div class="w-1/4 text-center">
                                    <div class="bg-emerald-100 text-emerald-800 font-semibold p-2 rounded-lg">Matching Service</div>
                                    <div class="h-full border-l-2 border-dashed border-slate-400 mx-auto w-0 mt-2"></div>
                                </div>
                                <div class="w-1/4 text-center">
                                    <div class="bg-amber-100 text-amber-800 font-semibold p-2 rounded-lg">Driver App</div>
                                    <div class="h-full border-l-2 border-dashed border-slate-400 mx-auto w-0 mt-2"></div>
                                </div>
                            </div>
                            <div class="mt-[-100%] relative space-y-6">
                                <div class="h-20"></div>
                                <div class="relative">
                                    <div class="absolute top-1/2 left-[12.5%] w-[12.5%] border-t-2 border-slate-600"></div>
                                    <p class="absolute top-1/2 left-[18.75%] -translate-y-6 text-sm">1. RequestRide()</p>
                                    <div class="absolute top-1/2 left-[25%] w-0 h-0 border-y-8 border-y-transparent border-l-8 border-l-slate-600"></div>
                                </div>
                                <div class="relative h-12">
                                     <div class="absolute top-1/2 left-[37.5%] w-[12.5%] border-t-2 border-slate-600"></div>
                                     <p class="absolute top-1/2 left-[43.75%] -translate-y-6 text-sm">2. FindDriver()</p>
                                     <div class="absolute top-1/2 left-[50%] w-0 h-0 border-y-8 border-y-transparent border-l-8 border-l-slate-600"></div>
                                </div>
                                 <div class="relative h-12">
                                     <div class="absolute top-1/2 right-[37.5%] w-[12.5%] border-t-2 border-dashed border-slate-500"></div>
                                     <p class="absolute top-1/2 right-[43.75%] -translate-y-6 text-sm">3. Return Driver</p>
                                     <div class="absolute top-1/2 right-[50%] w-0 h-0 border-y-8 border-y-transparent border-r-8 border-r-slate-500"></div>
                                </div>
                                 <div class="relative h-12">
                                     <div class="absolute top-1/2 left-[37.5%] w-[37.5%] border-t-2 border-slate-600"></div>
                                     <p class="absolute top-1/2 left-[56.25%] -translate-y-6 text-sm">4. NotifyDriver()</p>
                                     <div class="absolute top-1/2 left-[75%] w-0 h-0 border-y-8 border-y-transparent border-l-8 border-l-slate-600"></div>
                                </div>
                                <div class="relative h-12">
                                     <div class="absolute top-1/2 right-[12.5%] w-[37.5%] border-t-2 border-dashed border-slate-500"></div>
                                     <p class="absolute top-1/2 right-[31.25%] -translate-y-6 text-sm">5. AcceptRide()</p>
                                     <div class="absolute top-1/2 right-[50%] w-0 h-0 border-y-8 border-y-transparent border-r-8 border-r-slate-500"></div>
                                </div>
                                <div class="relative h-12">
                                     <div class="absolute top-1/2 right-[37.5%] w-[37.5%] border-t-2 border-dashed border-slate-500"></div>
                                     <p class="absolute top-1/2 right-[56.25%] -translate-y-6 text-sm">6. Update Rider</p>
                                     <div class="absolute top-1/2 right-[75%] w-0 h-0 border-y-8 border-y-transparent border-r-8 border-r-slate-500"></div>
                                </div>
                                <div class="relative h-12">
                                     <p class="text-center text-slate-500 text-sm">... Trip In Progress ...</p>
                                </div>
                                <div class="relative h-12">
                                     <div class="absolute top-1/2 right-[12.5%] w-[37.5%] border-t-2 border-slate-600"></div>
                                     <p class="absolute top-1/2 right-[31.25%] -translate-y-6 text-sm">7. EndTrip()</p>
                                     <div class="absolute top-1/2 right-[50%] w-0 h-0 border-y-8 border-y-transparent border-l-8 border-l-slate-600 transform -scale-x-100"></div>
                                </div>
                                 <div class="relative h-12">
                                     <div class="absolute top-1/2 right-[37.5%] w-[37.5%] border-t-2 border-dashed border-slate-500"></div>
                                     <p class="absolute top-1/2 right-[56.25%] -translate-y-6 text-sm">8. Trip Completed</p>
                                     <div class="absolute top-1/2 right-[75%] w-0 h-0 border-y-8 border-y-transparent border-r-8 border-r-slate-500"></div>
                                </div>
                                <div class="h-4"></div>
                            </div>
                         </div>
                    </section>

                    <section id="coding" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">✅ Coding Practice: C# Implementation</h3>
                        <p class="text-slate-600">Now, let's translate theory into practice. We'll use C# to model our core entities and implement the main functionalities. The code is structured to be clear and extensible.</p>

                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">Core Classes: Rider, Driver, Trip</h4>
                            <p class="mt-3 text-slate-600">First, we define the Plain Old C# Object (POCO) classes that represent our main entities. These classes will hold the state for each object in our system.</p>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
public class Location
{
    public double Latitude { get; set; }
    public double Longitude { get; set; }
}

public enum UserStatus { Active, Inactive }
public enum DriverStatus { Available, OnTrip, Offline }
public enum TripStatus { Requested, Accepted, InProgress, Completed, Cancelled }

public class Rider
{
    public Guid Id { get; private set; } = Guid.NewGuid();
    public string Name { get; set; }
    public UserStatus Status { get; set; } = UserStatus.Active;
    public double AverageRating { get; private set; }
}

public class Driver
{
    public Guid Id { get; private set; } = Guid.NewGuid();
    public string Name { get; set; }
    public DriverStatus Status { get; set; } = DriverStatus.Offline;
    public double AverageRating { get; private set; }
    public Location CurrentLocation { get; set; }
}

public class Trip
{
    public Guid Id { get; private set; } = Guid.NewGuid();
    public Guid RiderId { get; set; }
    public Guid? DriverId { get; set; }
    public Location Origin { get; set; }
    public Location Destination { get; set; }
    public TripStatus Status { get; set; }
    public double Fare { get; set; }
    public DateTime RequestedAt { get; private set; } = DateTime.UtcNow;
    public DateTime? CompletedAt { get; set; }
}
                                </code></pre>
                            </div>
                        </div>

                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">[Easy] Register Rider & Driver</h4>
                            <p class="mt-3 text-slate-600">We need a way to manage our users. A manager class is a good pattern for this. It will hold our "database" of riders and drivers in memory for this example and provide methods to add new ones.</p>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
using System.Collections.Concurrent;

public class UserManager
{
    private readonly ConcurrentDictionary&lt;Guid, Rider&gt; riders = new();
    private readonly ConcurrentDictionary&lt;Guid, Driver&gt; drivers = new();

    public Rider RegisterRider(string name)
    {
        var rider = new Rider { Name = name };
        riders.TryAdd(rider.Id, rider);
        Console.WriteLine($"Rider '{name}' registered with ID: {rider.Id}");
        return rider;
    }

    public Driver RegisterDriver(string name, Location initialLocation)
    {
        var driver = new Driver { Name = name, CurrentLocation = initialLocation, Status = DriverStatus.Available };
        drivers.TryAdd(driver.Id, driver);
        Console.WriteLine($"Driver '{name}' registered at ({initialLocation.Latitude}, {initialLocation.Longitude})");
        return driver;
    }

    public Rider GetRider(Guid id) => riders.GetValueOrDefault(id);
    public Driver GetDriver(Guid id) => drivers.GetValueOrDefault(id);
    public IEnumerable&lt;Driver&gt; GetAvailableDrivers() => drivers.Values.Where(d => d.Status == DriverStatus.Available);
}
                                </code></pre>
                            </div>
                        </div>

                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">[Medium] Assign Nearest Driver</h4>
                            <p class="mt-3 text-slate-600">This is the core of our matching logic. The `TripManager` will be responsible for creating trips and finding a suitable driver. For simplicity, we'll use Euclidean distance, but in a real system, you'd use the Haversine formula and a mapping API for ETAs.</p>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
public static class DistanceCalculator
{
    // Simple Euclidean distance for demo purposes.
    // Real-world: Use Haversine formula and mapping APIs.
    public static double CalculateDistance(Location loc1, Location loc2)
    {
        double dx = loc1.Latitude - loc2.Latitude;
        double dy = loc1.Longitude - loc2.Longitude;
        return Math.Sqrt(dx * dx + dy * dy);
    }
}

public class TripManager
{
    private readonly ConcurrentDictionary&lt;Guid, Trip&gt; trips = new();
    private readonly UserManager userManager;
    private readonly PricingManager pricingManager;

    public TripManager(UserManager userManager, PricingManager pricingManager)
    {
        this.userManager = userManager;
        this.pricingManager = pricingManager;
    }

    public Trip RequestTrip(Guid riderId, Location origin, Location destination)
    {
        var rider = userManager.GetRider(riderId);
        if (rider == null)
        {
            Console.WriteLine("Invalid rider ID.");
            return null;
        }

        var availableDrivers = userManager.GetAvailableDrivers().ToList();
        if (!availableDrivers.Any())
        {
            Console.WriteLine("No available drivers at the moment.");
            return null;
        }

        // Find the nearest driver
        Driver nearestDriver = availableDrivers
            .OrderBy(driver => DistanceCalculator.CalculateDistance(driver.CurrentLocation, origin))
            .FirstOrDefault();
        
        if (nearestDriver == null) {
             Console.WriteLine("Could not find a suitable driver.");
             return null;
        }

        // Create the trip
        var fare = pricingManager.CalculateFare(origin, destination);
        var trip = new Trip
        {
            RiderId = riderId,
            DriverId = nearestDriver.Id,
            Origin = origin,
            Destination = destination,
            Status = TripStatus.Accepted,
            Fare = fare
        };

        trips.TryAdd(trip.Id, trip);
        
        nearestDriver.Status = DriverStatus.OnTrip;

        Console.WriteLine($"Trip {trip.Id} created. Driver {nearestDriver.Name} assigned to Rider {rider.Name}. Fare: ${fare:F2}");
        return trip;
    }
}
                                </code></pre>
                            </div>
                        </div>

                         <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-xl font-semibold text-slate-800 font-lexend">[Hard] Handle Surge Pricing with Concurrency</h4>
                            <p class="mt-3 text-slate-600">Surge pricing requires real-time analysis of supply and demand. The system must be thread-safe, as many requests and driver status updates can happen concurrently. We'll use a `ConcurrentDictionary` to track demand and supply in different zones and a `Timer` to periodically update the surge multiplier.</p>
                             <blockquote class="mt-4 border-l-4 border-amber-400 bg-amber-50 p-4 text-amber-800 rounded-r-lg">
                                <strong>Concurrency Challenge</strong>
                                <p class="text-sm mt-1">The main challenge here is avoiding race conditions. If we read the supply/demand counts, calculate a multiplier, and then write it back, another thread could have changed the counts in between. Using locks or thread-safe collections like `ConcurrentDictionary` is essential to ensure data consistency.</p>
                            </blockquote>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
public class PricingManager
{
    private const double BaseFare = 2.50;
    private const double PerKmRate = 1.50;
    private static readonly ConcurrentDictionary&lt;int, double&gt; surgeMultipliersByZone = new();
    private static readonly ConcurrentDictionary&lt;int, int&gt; riderRequestsByZone = new();
    private static readonly ConcurrentDictionary&lt;int, int&gt; availableDriversByZone = new();
    private Timer surgeUpdateTimer;

    public PricingManager()
    {
        // Update surge prices every 30 seconds
        surgeUpdateTimer = new Timer(UpdateSurgeMultipliers, null, 0, 30000);
    }

    public double CalculateFare(Location origin, Location destination)
    {
        double distance = DistanceCalculator.CalculateDistance(origin, destination) * 10; // Mock distance
        int zone = GetZone(origin);
        double multiplier = surgeMultipliersByZone.GetOrAdd(zone, 1.0);
        
        return (BaseFare + (distance * PerKmRate)) * multiplier;
    }

    private void UpdateSurgeMultipliers(object state)
    {
        Console.WriteLine("\nUpdating surge multipliers...");
        foreach (var zone in riderRequestsByZone.Keys.Union(availableDriversByZone.Keys))
        {
            int demand = riderRequestsByZone.GetOrAdd(zone, 0);
            int supply = availableDriversByZone.GetOrAdd(zone, 1); // Avoid division by zero

            double ratio = (double)demand / supply;
            double newMultiplier = 1.0;

            if (ratio > 5) newMultiplier = 2.0;
            else if (ratio > 3) newMultiplier = 1.5;
            else if (ratio > 2) newMultiplier = 1.2;

            surgeMultipliersByZone[zone] = newMultiplier;
            Console.WriteLine($"Zone {zone}: Demand={demand}, Supply={supply}, New Multiplier={newMultiplier:F1}x");
        }
        // Reset counts for the next window
        riderRequestsByZone.Clear();
        availableDriversByZone.Clear();
    }

    // This would be called whenever a rider requests or a driver changes status
    public void LogDemand(Location location) => riderRequestsByZone.AddOrUpdate(GetZone(location), 1, (key, count) => count + 1);
    public void LogSupply(Location location) => availableDriversByZone.AddOrUpdate(GetZone(location), 1, (key, count) => count + 1);
    
    // Simple zoning based on integer parts of lat/lon
    private int GetZone(Location location) => (int)location.Latitude + (int)location.Longitude;
}
                                </code></pre>
                            </div>
                        </div>
                    </section>

                    <section id="case-study" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">✅ Case Study: Build Ride-Hailing Backend Service</h3>
                        <p class="text-slate-600">Let's put all the pieces together into a runnable console application. This simulation will register users, have them request rides in parallel to test our concurrency handling, and show the system in action.</p>
                        <div class="code-block mt-4">
                            <button class="copy-btn">Copy</button>
                            <pre class="bg-slate-900 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
// Main Program to run the simulation
public class RideHailingSimulation
{
    public static async Task Main(string[] args)
    {
        var userManager = new UserManager();
        var pricingManager = new PricingManager();
        var tripManager = new TripManager(userManager, pricingManager);
        var random = new Random();

        Console.WriteLine("--- Ride-Hailing Service Simulation ---");

        // Register drivers
        var driver1 = userManager.RegisterDriver("Alice", new Location { Latitude = 10.1, Longitude = 10.1 });
        var driver2 = userManager.RegisterDriver("Bob", new Location { Latitude = 10.5, Longitude = 10.5 });
        var driver3 = userManager.RegisterDriver("Charlie", new Location { Latitude = 11.0, Longitude = 11.0 });

        // Register riders
        var rider1 = userManager.RegisterRider("Dave");
        var rider2 = userManager.RegisterRider("Eve");
        var rider3 = userManager.RegisterRider("Frank");
        
        Console.WriteLine("\n--- Simulating High Demand Period ---");
        
        // Simulate high demand in a specific zone
        for(int i = 0; i < 15; i++) {
             pricingManager.LogDemand(new Location { Latitude = 10.2, Longitude = 10.2 });
        }
        // Log available drivers
        pricingManager.LogSupply(driver1.CurrentLocation);
        pricingManager.LogSupply(driver2.CurrentLocation);
        pricingManager.LogSupply(driver3.CurrentLocation);

        // Wait for surge update
        await Task.Delay(1000); 

        Console.WriteLine("\n--- Simulating Concurrent Ride Requests ---");

        // Use Task.WhenAll to simulate concurrent requests
        var requestTasks = new List&lt;Task&gt;
        {
            Task.Run(() => tripManager.RequestTrip(rider1.Id, new Location { Latitude = 10.2, Longitude = 10.2 }, new Location { Latitude = 12.0, Longitude = 12.0 })),
            Task.Run(() => tripManager.RequestTrip(rider2.Id, new Location { Latitude = 10.6, Longitude = 10.6 }, new Location { Latitude = 13.0, Longitude = 13.0 })),
            Task.Run(() => tripManager.RequestTrip(rider3.Id, new Location { Latitude = 10.8, Longitude = 10.8 }, new Location { Latitude = 14.0, Longitude = 14.0 }))
        };

        await Task.WhenAll(requestTasks);
        
        Console.WriteLine("\n--- Simulation Complete ---");
    }
}
// To run this: Place all classes (Location, Rider, etc.) in the same file or project and run the Main method.
                            </code></pre>
                        </div>
                    </section>

                    <section id="quiz" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">🧠 Enhanced Knowledge Check</h3>
                        <p class="text-slate-600">Test your understanding of the core concepts of ride-hailing backend design.</p>
                        <div id="quiz-container" class="space-y-6"></div>
                    </section>

                    <section id="challenge" class="space-y-8">
                        <h3 class="text-2xl font-bold text-slate-900 font-lexend border-b pb-2">🏆 Self-Assessment Challenge</h3>
                        <div class="p-6 bg-white rounded-xl shadow-sm">
                            <h4 class="text-lg font-semibold text-slate-800">Challenge: Implement Driver Ratings</h4>
                            <p class="mt-3 text-slate-600">Extend the current system to allow riders to rate drivers after a trip is completed. Consider the following:</p>
                            <ul class="mt-4 list-disc list-inside space-y-2 text-slate-700">
                                <li>Add a `RateDriver(Guid tripId, int rating)` method to the `TripManager`.</li>
                                <li>The rating should be between 1 and 5.</li>
                                <li>When a driver is rated, their `AverageRating` in the `Driver` class should be updated. How would you calculate the new average efficiently without storing all previous ratings?</li>
                                <li>Ensure that a trip can only be rated once and only after it is `COMPLETED`.</li>
                            </ul>
                            <button id="toggleSolutionBtn" class="mt-6 bg-slate-200 text-slate-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors shadow-sm">Show Solution</button>
                            <div id="solution" class="hidden mt-4 border-t pt-4">
                                <p class="text-slate-600">To calculate the new average rating efficiently, you need to store the total number of ratings along with the average. Let's say a driver has an `AverageRating` of 4.5 from `TotalRatings` of 100. The total sum of ratings is `4.5 * 100 = 450`. When a new rating of 5 comes in, the new sum is `450 + 5 = 455`, and the new total ratings count is 101. The new average is `455 / 101 = 4.505`.</p>
                                <div class="code-block mt-4">
                                    <button class="copy-btn">Copy</button>
                                    <pre class="bg-slate-800 text-white p-4 rounded-lg overflow-x-auto text-sm"><code class="language-csharp">
// Add to Driver class:
public int TotalRatings { get; private set; } = 0;
private double _totalRatingSum = 0.0;

public void UpdateRating(int newRating)
{
    if (newRating < 1 || newRating > 5) return;
    _totalRatingSum += newRating;
    TotalRatings++;
    AverageRating = _totalRatingSum / TotalRatings;
}

// Add to TripManager class:
public void RateDriver(Guid tripId, int rating)
{
    if (!trips.TryGetValue(tripId, out var trip))
    {
        Console.WriteLine("Invalid Trip ID.");
        return;
    }

    if (trip.Status != TripStatus.Completed)
    {
        Console.WriteLine("Can only rate completed trips.");
        return;
    }
    
    if (trip.DriverId == null) return;
    
    var driver = userManager.GetDriver(trip.DriverId.Value);
    if (driver != null)
    {
        driver.UpdateRating(rating);
        Console.WriteLine($"Driver {driver.Name} new rating is {driver.AverageRating:F2} from {driver.TotalRatings} ratings.");
    }
}
                                    </code></pre>
                                </div>
                            </div>
                        </div>
                    </section>

                </article>
            </div>

            <aside class="lg:w-1/4 lg:sticky top-8 self-start">
                <div class="p-6 bg-white rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold text-slate-900 font-lexend">On this page</h3>
                    <nav id="toc" class="mt-4">
                        <ul class="space-y-2">
                            <li><a href="#theory" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Theory Topics</a></li>
                            <li><a href="#uml" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">UML Sequence Diagram</a></li>
                            <li><a href="#coding" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Coding Practice</a></li>
                            <li><a href="#case-study" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Case Study</a></li>
                            <li><a href="#quiz" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Knowledge Check</a></li>
                            <li><a href="#challenge" class="toc-link block text-slate-600 border-l-2 border-slate-200 pl-3 hover:text-sky-600 hover:border-sky-600">Self-Assessment Challenge</a></li>
                        </ul>
                    </nav>
                </div>
            </aside>
        </div>
    </main>

    <footer class="text-center mt-16 py-8 border-t border-slate-200">
        <p class="text-slate-700 font-semibold">Low-Level Design Bootcamp</p>
        <p class="text-sm text-slate-500 mt-2">A personalized learning roadmap curated by Mr. Mahesh Singare.</p>
        <p class="text-xs text-slate-400 mt-4">&copy; 2025. All Rights Reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- Matching Canvas ---
            const canvas = document.getElementById('matchingCanvas');
            const ctx = canvas.getContext('2d');
            const findDriverBtn = document.getElementById('findDriverBtn');
            let rider = { x: 0, y: 0 };
            let drivers = [];

            function resizeCanvas() {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                resetAndDraw();
            }

            function resetAndDraw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                rider = { x: canvas.width * 0.2, y: canvas.height * 0.5 };
                drivers = [
                    { x: canvas.width * 0.5, y: canvas.height * 0.2, name: 'D1' },
                    { x: canvas.width * 0.8, y: canvas.height * 0.4, name: 'D2' },
                    { x: canvas.width * 0.6, y: canvas.height * 0.8, name: 'D3' },
                    { x: canvas.width * 0.3, y: canvas.height * 0.3, name: 'D4' },
                ];
                
                // Draw Rider
                ctx.beginPath();
                ctx.arc(rider.x, rider.y, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#0ea5e9';
                ctx.fill();
                ctx.closePath();
                ctx.font = '12px Inter';
                ctx.fillStyle = '#0c4a6e';
                ctx.fillText('Rider', rider.x - 15, rider.y + 20);

                // Draw Drivers
                drivers.forEach(driver => {
                    ctx.beginPath();
                    ctx.arc(driver.x, driver.y, 6, 0, Math.PI * 2);
                    ctx.fillStyle = '#f59e0b';
                    ctx.fill();
                    ctx.closePath();
                    ctx.fillStyle = '#78350f';
                    ctx.fillText(driver.name, driver.x - 5, driver.y - 10);
                });
            }

            findDriverBtn.addEventListener('click', () => {
                resetAndDraw();
                let nearestDriver = null;
                let minDistance = Infinity;

                drivers.forEach(driver => {
                    const dist = Math.sqrt(Math.pow(rider.x - driver.x, 2) + Math.pow(rider.y - driver.y, 2));
                    if (dist < minDistance) {
                        minDistance = dist;
                        nearestDriver = driver;
                    }
                });

                if (nearestDriver) {
                    // Highlight nearest
                    ctx.beginPath();
                    ctx.arc(nearestDriver.x, nearestDriver.y, 8, 0, Math.PI * 2);
                    ctx.strokeStyle = '#22c55e';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    ctx.closePath();
                    
                    // Draw line
                    ctx.beginPath();
                    ctx.moveTo(rider.x, rider.y);
                    ctx.lineTo(nearestDriver.x, nearestDriver.y);
                    ctx.strokeStyle = '#64748b';
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.closePath();
                }
            });
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            // --- Surge Chart ---
            const surgeCtx = document.getElementById('surgeChart').getContext('2d');
            const demandSlider = document.getElementById('demandSlider');
            const supplySlider = document.getElementById('supplySlider');

            const surgeChart = new Chart(surgeCtx, {
                type: 'bar',
                data: {
                    labels: ['Surge Multiplier'],
                    datasets: [{
                        label: 'Price Multiplier',
                        data: [1],
                        backgroundColor: ['#38bdf8'],
                        borderColor: ['#0284c7'],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 3.0,
                            title: {
                                display: true,
                                text: 'Multiplier (e.g., 1.5x)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    return `Multiplier: ${context.raw.toFixed(1)}x`;
                                }
                            }
                        }
                    }
                }
            });

            function updateSurgeChart() {
                const demand = parseInt(demandSlider.value);
                const supply = parseInt(supplySlider.value);
                const ratio = demand / Math.max(1, supply);

                let multiplier = 1.0;
                let color = '#38bdf8';

                if (ratio > 5) {
                    multiplier = 2.5;
                    color = '#ef4444';
                } else if (ratio > 3) {
                    multiplier = 2.0;
                    color = '#f97316';
                } else if (ratio > 1.5) {
                    multiplier = 1.5;
                    color = '#f59e0b';
                }
                
                surgeChart.data.datasets[0].data[0] = multiplier;
                surgeChart.data.datasets[0].backgroundColor[0] = color;
                surgeChart.data.datasets[0].borderColor[0] = color;
                surgeChart.update();
            }

            demandSlider.addEventListener('input', updateSurgeChart);
            supplySlider.addEventListener('input', updateSurgeChart);
            updateSurgeChart();


            // --- TOC Active State ---
            const sections = document.querySelectorAll('section[id]');
            const tocLinks = document.querySelectorAll('#toc a');
            
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        tocLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href') === `#${id}`) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, { rootMargin: '-50% 0px -50% 0px' });

            sections.forEach(section => observer.observe(section));


            // --- Copy to Clipboard ---
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const code = button.nextElementSibling.querySelector('code').innerText;
                    navigator.clipboard.writeText(code).then(() => {
                        button.innerText = 'Copied!';
                        setTimeout(() => { button.innerText = 'Copy'; }, 2000);
                    });
                });
            });

            // --- Quiz Logic ---
            const quizData = [
                {
                    question: "What is the primary goal of the driver-rider matching algorithm?",
                    options: ["To find the driver with the highest rating", "To minimize the rider's wait time and driver's pickup travel time", "To maximize the fare for the company", "To assign the driver who has been waiting the longest"],
                    answer: "To minimize the rider's wait time and driver's pickup travel time"
                },
                {
                    question: "What is the main economic purpose of surge pricing?",
                    options: ["To punish riders for requesting during busy times", "To give drivers a random bonus", "To balance supply (drivers) and demand (riders)", "To make rides more expensive than taxis"],
                    answer: "To balance supply (drivers) and demand (riders)"
                },
                 {
                    question: "Which data structure is most suitable for handling concurrent updates to driver locations and statuses in C#?",
                    options: ["List<T>", "Dictionary<K,V>", "ConcurrentDictionary<K,V>", "Array"],
                    answer: "ConcurrentDictionary<K,V>"
                },
                {
                    question: "In a sequence diagram for a ride request, what is the first component the 'Backend Service' typically communicates with?",
                    options: ["Payment Gateway", "Driver App", "Rider App", "Matching Service"],
                    answer: "Matching Service"
                }
            ];

            const quizContainer = document.getElementById('quiz-container');
            quizData.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'p-6 bg-white rounded-xl shadow-sm';
                questionEl.innerHTML = `
                    <p class="font-semibold text-slate-800">${index + 1}. ${q.question}</p>
                    <div class="mt-4 space-y-3" id="options-${index}">
                        ${q.options.map((opt, i) => `<div data-answer="${opt}" class="quiz-option cursor-pointer p-3 border-2 border-slate-200 rounded-lg hover:bg-slate-100 hover:border-sky-300">${opt}</div>`).join('')}
                    </div>
                    <p id="feedback-${index}" class="mt-3 text-sm font-semibold hidden"></p>
                `;
                quizContainer.appendChild(questionEl);

                document.getElementById(`options-${index}`).addEventListener('click', (e) => {
                    const selectedOption = e.target.closest('.quiz-option');
                    if (!selectedOption) return;

                    const isCorrect = selectedOption.dataset.answer === q.answer;
                    const feedbackEl = document.getElementById(`feedback-${index}`);

                    Array.from(selectedOption.parentElement.children).forEach(child => {
                        child.classList.remove('correct', 'incorrect');
                        child.style.pointerEvents = 'none'; 
                    });

                    selectedOption.classList.add(isCorrect ? 'correct' : 'incorrect');
                    feedbackEl.textContent = isCorrect ? 'Correct!' : `Incorrect. The correct answer is: ${q.answer}`;
                    feedbackEl.className = `mt-3 text-sm font-semibold ${isCorrect ? 'text-green-600' : 'text-red-600'}`;
                    feedbackEl.classList.remove('hidden');
                });
            });


            // --- Solution Toggler ---
            const toggleSolutionBtn = document.getElementById('toggleSolutionBtn');
            const solutionDiv = document.getElementById('solution');
            toggleSolutionBtn.addEventListener('click', () => {
                const isHidden = solutionDiv.classList.contains('hidden');
                solutionDiv.classList.toggle('hidden');
                toggleSolutionBtn.textContent = isHidden ? 'Hide Solution' : 'Show Solution';
            });
        });
    </script>
</body>
</html>
