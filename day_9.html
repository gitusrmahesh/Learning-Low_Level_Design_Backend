<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Day 9: Race Conditions & Locks in C#</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A two-column layout was chosen for optimal learning experience. The left, wider column contains the main lesson content in a logical, top-down flow from theory to practical application. This linear progression is ideal for educational material. The right, narrower column features a sticky Table of Contents (TOC) for easy navigation, allowing users to jump between sections without losing their place. Interactions include tabbed views for problems/solutions, an interactive visualization to demonstrate race conditions, and a quiz with instant feedback, all designed to reinforce learning through active engagement. -->
    <!-- Visualization & Content Choices: Report Info: Race Condition -> Goal: Demonstrate the unpredictable nature of concurrent access. -> Viz/Presentation: Interactive HTML/JS simulation showing two threads incrementing a counter, with and without a lock. -> Interaction: User clicks "Run" to see the outcome, visually comparing the correct (locked) and incorrect (unlocked) results. -> Justification: This makes an abstract concept tangible and memorable. Report Info: UML Activity Diagram -> Goal: Illustrate a thread-safe process flow. -> Viz/Presentation: Diagram built with structured HTML & Tailwind CSS. -> Interaction: Key steps highlight on hover. -> Justification: Avoids static images (SVG), making it responsive and stylable. All coding examples use styled blocks with copy-to-clipboard functionality for ease of use. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; 
            color: #1e293b;
        }
        .font-lexend { 
            font-family: 'Lexend', sans-serif; 
        }
        .toc-link.active {
            color: #0891b2;
            font-weight: 600;
            border-left-color: #0891b2;
        }
        .code-block {
            background-color: #1e293b;
            color: #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            position: relative;
            overflow-x: auto;
        }
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #475569;
            color: #e2e8f0;
            border: none;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .copy-btn:hover {
            background-color: #64748b;
        }
        .tab-btn.active {
            border-bottom-color: #0891b2;
            color: #0891b2;
            font-weight: 600;
        }
        .quiz-option:hover {
            background-color: #f1f5f9;
        }
        .quiz-option.selected {
            border-color: #0891b2;
            background-color: #f0f9ff;
        }
        .quiz-option.correct {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        .quiz-option.incorrect {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .highlight {
            background-color: #e0f2fe;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            color: #0ea5e9;
        }
        .thread-icon {
            transition: transform 1s ease-in-out;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
     <div class="bg-slate-100/80 border-b border-slate-200">
        <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 relative">
            <header class="text-center">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-slate-800 mt-1 tracking-tight font-lexend">Low-Level Design Bootcamp</h1>
                <p class="mt-3 text-slate-600 max-w-xl mx-auto">Your 60-Day Interactive Roadmap to Mastering Backend Engineering.</p>
            </header>
            <a href="roadmap.html" class="absolute top-1/2 -translate-y-1/2 right-4 sm:right-6 lg:right-8 bg-slate-200 text-slate-700 text-sm font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors shadow-sm">
                Return to Homepage
            </a>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Main Content -->
            <main class="w-full lg:w-3/4">
                <header class="mb-12">
                    <h1 class="text-4xl md:text-5xl font-bold text-slate-800 tracking-tight">Day 9: Race Conditions & Locks</h1>
                    <p class="mt-4 text-lg text-slate-600">Mastering the art of thread safety by understanding, identifying, and preventing one of the most common concurrency bugs.</p>
                </header>

                <!-- Theory Topics -->
                <section id="theory" class="space-y-12">
                    <h2 class="text-3xl font-bold text-slate-800 border-b pb-2">Theory Deep Dive</h2>
                    
                    <!-- Race Condition -->
                    <article id="theory-race-condition">
                        <h3 class="text-2xl font-semibold text-slate-700">What is a Race Condition?</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            A race condition occurs when two or more threads access a shared resource (like a variable or file) and try to change it at the same time. Because the scheduler can swap between threads at any moment, the final outcome depends on the unpredictable sequence in which the threads are scheduled. This leads to non-deterministic and often incorrect behavior.
                        </p>
                        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p><strong class="text-blue-700">Analogy: The Shared Whiteboard</strong></p>
                            <p class="mt-2 text-blue-600">Imagine two people, Alice and Bob, are asked to update a number on a whiteboard. The number is currently 5. Their task is to add 1 to it.
                            <br>1. Alice reads the number (5).
                            <br>2. Bob reads the number (5).
                            <br>3. Alice calculates her result (5 + 1 = 6).
                            <br>4. Bob calculates his result (5 + 1 = 6).
                            <br>5. Alice erases 5 and writes 6.
                            <br>6. Bob erases 6 and writes 6.
                            <br>The final number is 6, but it should have been 7. This is a race condition in action.
                            </p>
                        </div>
                    </article>

                     <!-- Interactive Visualization -->
                    <article id="visualization">
                        <h3 class="text-2xl font-semibold text-slate-700">Interactive Race Condition Demo</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            This visualization demonstrates what happens when multiple threads try to increment a shared counter. Click "Run Simulation" to see the difference between an unprotected operation (leading to a race condition) and a protected operation using a lock.
                        </p>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 p-6 border rounded-lg bg-slate-50">
                            <!-- Unlocked Version -->
                            <div>
                                <h4 class="font-bold text-lg text-center text-red-600">Without a Lock (Race Condition)</h4>
                                <div class="relative h-48 mt-4 p-4 border-2 border-dashed border-red-300 rounded-lg flex items-center justify-center">
                                    <div id="unlocked-box" class="text-center">
                                        <div class="text-slate-500 text-sm">Shared Counter</div>
                                        <div id="unlocked-counter" class="text-5xl font-bold text-slate-800">0</div>
                                    </div>
                                    <div id="thread1-unlocked" class="thread-icon absolute left-0 top-1/4 transform -translate-x-12">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                    <div id="thread2-unlocked" class="thread-icon absolute right-0 top-1/2 transform translate-x-12">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                </div>
                                <p class="text-center mt-2 text-sm text-slate-500">Expected: 200, Actual: <span id="unlocked-result" class="font-semibold">?</span></p>
                            </div>
                            <!-- Locked Version -->
                            <div>
                                <h4 class="font-bold text-lg text-center text-green-600">With a Lock (Thread-Safe)</h4>
                                <div class="relative h-48 mt-4 p-4 border-2 border-dashed border-green-300 rounded-lg flex items-center justify-center">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                    </div>
                                    <div id="locked-box" class="text-center z-10">
                                        <div class="text-slate-500 text-sm">Shared Counter</div>
                                        <div id="locked-counter" class="text-5xl font-bold text-slate-800">0</div>
                                    </div>
                                    <div id="thread1-locked" class="thread-icon absolute left-0 top-1/4 transform -translate-x-12">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                    <div id="thread2-locked" class="thread-icon absolute right-0 top-1/2 transform translate-x-12">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                    </div>
                                </div>
                                <p class="text-center mt-2 text-sm text-slate-500">Expected: 200, Actual: <span id="locked-result" class="font-semibold">?</span></p>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <button id="run-simulation-btn" class="px-6 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-700 transition-colors">Run Simulation</button>
                        </div>
                    </article>

                    <!-- Critical Sections -->
                    <article id="theory-critical-section">
                        <h3 class="text-2xl font-semibold text-slate-700">Critical Sections & Shared Resources</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            A <span class="highlight">shared resource</span> is any data or resource that can be accessed by multiple threads (e.g., static variables, shared object instances, files).
                            <br><br>
                            A <span class="highlight">critical section</span> is a piece of code that accesses a shared resource and must not be concurrently executed by more than one thread. To prevent race conditions, we must ensure "mutual exclusion" within critical sections, meaning only one thread can be inside that section at any given time.
                        </p>
                    </article>

                    <!-- Locking Mechanisms -->
                    <article id="theory-locking">
                        <h3 class="text-2xl font-semibold text-slate-700">Locking Mechanisms in C#</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            C# provides mechanisms to enforce mutual exclusion and protect critical sections. The most common is the `lock` statement.
                        </p>
                        
                        <div class="mt-6">
                            <h4 class="text-xl font-medium text-slate-700">The `lock` Statement</h4>
                            <p class="mt-2 text-slate-600">The `lock` keyword marks a block of code as a critical section. It takes an object as an argument, which acts as a "key". A thread must acquire the key (the lock) before it can enter the critical section. While one thread holds the lock, any other thread that tries to acquire the same lock will be blocked until the lock is released.</p>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-csharp">private readonly object _lockObject = new object();
                                
public void MyThreadSafeMethod()
{
    lock (_lockObject)
    {
        // This is the critical section.
        // Only one thread can be in here at a time.
        // ... access shared resources ...
    }
}</code></pre>
                            </div>
                            <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800">
                                <strong>Best Practice:</strong> Always lock on a `private readonly` object instance. Avoid locking on `this`, `typeof(MyClass)`, or strings, as this can lead to deadlocks if other unrelated code locks on the same public object.
                            </div>
                        </div>

                        <div class="mt-8">
                            <h4 class="text-xl font-medium text-slate-700">The `Monitor` Class</h4>
                            <p class="mt-2 text-slate-600">The `lock` statement is actually syntactic sugar for the `Monitor` class. The code above is equivalent to:</p>
                            <div class="code-block mt-4">
                                <button class="copy-btn">Copy</button>
                                <pre><code class="language-csharp">private readonly object _lockObject = new object();

public void MyThreadSafeMethod()
{
    System.Threading.Monitor.Enter(_lockObject);
    try
    {
        // Critical section
    }
    finally
    {
        System.Threading.Monitor.Exit(_lockObject);
    }
}</code></pre>
                            </div>
                            <p class="mt-4 text-slate-600">While `lock` is preferred for its simplicity and safety (it guarantees the lock is released via the `finally` block), `Monitor` provides more advanced features like `TryEnter` (to attempt acquiring a lock without blocking) and `Wait`/`Pulse` (for thread coordination).</p>
                        </div>
                    </article>

                    <!-- Deadlocks -->
                    <article id="theory-deadlocks">
                        <h3 class="text-2xl font-semibold text-slate-700">Pitfall: Deadlocks</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            A deadlock is a situation where two or more threads are blocked forever, waiting for each other. This typically happens when threads acquire locks in a different order.
                        </p>
                        <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p><strong class="text-red-700">Deadlock Scenario:</strong></p>
                            <p class="mt-2 text-red-600">
                                1. Thread A acquires Lock 1.<br>
                                2. Thread B acquires Lock 2.<br>
                                3. Thread A tries to acquire Lock 2, but it's held by Thread B, so Thread A waits.<br>
                                4. Thread B tries to acquire Lock 1, but it's held by Thread A, so Thread B waits.<br>
                                Now, both threads are waiting for a lock held by the other, and neither can proceed. The application freezes.
                            </p>
                            <p class="mt-4 text-red-700"><strong>Prevention:</strong> The most common way to prevent deadlocks is to ensure all threads acquire locks in the same, consistent order.</p>
                        </div>
                    </article>
                </section>

                <!-- Coding Practice -->
                <section id="practice" class="mt-16 space-y-12">
                    <h2 class="text-3xl font-bold text-slate-800 border-b pb-2">Coding Practice Arena</h2>

                    <!-- Bank Account Class -->
                    <article id="practice-bank-account">
                        <h3 class="text-2xl font-semibold text-slate-700">Core Task: Thread-Safe BankAccount Class</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            The primary goal is to implement a `BankAccount` class where `Deposit` and `Withdraw` methods can be called by multiple threads concurrently without corrupting the account balance. This requires identifying the critical section and protecting it with a lock.
                        </p>
                        <div class="code-block mt-4">
                            <button class="copy-btn">Copy</button>
                            <pre><code class="language-csharp">using System;
using System.Threading;

public class BankAccount
{
    private decimal _balance;
    private readonly object _balanceLock = new object();

    public BankAccount(decimal initialBalance)
    {
        _balance = initialBalance;
    }

    public void Deposit(decimal amount)
    {
        lock (_balanceLock)
        {
            // Critical Section: Read, update, and write the balance
            Console.WriteLine($"+ Thread {Thread.CurrentThread.ManagedThreadId} is depositing {amount:C}");
            decimal tempBalance = _balance;
            // Simulate work/delay to increase chance of race condition without lock
            Thread.Sleep(5); 
            tempBalance += amount;
            _balance = tempBalance;
            Console.WriteLine($"  Thread {Thread.CurrentThread.ManagedThreadId} new balance is {_balance:C}");
        }
    }

    public void Withdraw(decimal amount)
    {
        lock (_balanceLock)
        {
            // Critical Section
            if (_balance >= amount)
            {
                Console.WriteLine($"- Thread {Thread.CurrentThread.ManagedThreadId} is withdrawing {amount:C}");
                decimal tempBalance = _balance;
                Thread.Sleep(5);
                tempBalance -= amount;
                _balance = tempBalance;
                Console.WriteLine($"  Thread {Thread.CurrentThread.ManagedThreadId} new balance is {_balance:C}");
            }
            else
            {
                Console.WriteLine($"x Thread {Thread.CurrentThread.ManagedThreadId} failed to withdraw {amount:C} (insufficient funds)");
            }
        }
    }

    public decimal GetBalance()
    {
        // Even reads can be protected if needed for atomicity with other operations
        lock (_balanceLock)
        {
            return _balance;
        }
    }
}</code></pre>
                        </div>
                    </article>

                    <!-- Problem Solutions -->
                    <div class="space-y-8">
                        <!-- Easy Problem -->
                        <article id="practice-easy">
                            <h4 class="text-xl font-medium text-slate-700">[Easy] Print Numbers 1-100 from Two Threads</h4>
                            <p class="mt-2 text-slate-600">The goal is to have two threads cooperatively print numbers from 1 to 100 in order, without any duplicates or missed numbers. This requires a shared counter and a lock to ensure each number is printed exactly once.</p>
                            <div class="mt-4">
                                <div class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                        <button class="tab-btn active py-2 px-1 border-b-2 font-medium text-sm" data-tab="easy-solution">C# Solution</button>
                                    </nav>
                                </div>
                                <div id="easy-solution" class="tab-content mt-4">
                                    <div class="code-block">
                                        <button class="copy-btn">Copy</button>
                                        <pre><code class="language-csharp">public class NumberPrinter
{
    private int _number = 1;
    private readonly object _lock = new object();

    public void PrintNumbers()
    {
        while (true)
        {
            lock (_lock)
            {
                if (_number > 100)
                {
                    break; // Exit loop
                }
                Console.WriteLine($"Thread {Thread.CurrentThread.ManagedThreadId}: {_number}");
                _number++;
            }
            Thread.Sleep(10); // Give other thread a chance to run
        }
    }

    public static void Run()
    {
        var printer = new NumberPrinter();
        var t1 = new Thread(printer.PrintNumbers);
        var t2 = new Thread(printer.PrintNumbers);

        t1.Start();
        t2.Start();

        t1.Join();
        t2.Join();
    }
}

// To run: NumberPrinter.Run();</code></pre>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <!-- Medium Problem -->
                        <article id="practice-medium">
                            <h4 class="text-xl font-medium text-slate-700">[Medium] Bank Account Simulation</h4>
                            <p class="mt-2 text-slate-600">Simulate a bank account with multiple users (threads) making deposits and withdrawals simultaneously. Use the `BankAccount` class created earlier and verify that the final balance is correct.</p>
                             <div class="mt-4">
                                <div class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                        <button class="tab-btn active py-2 px-1 border-b-2 font-medium text-sm" data-tab="medium-solution">C# Solution</button>
                                    </nav>
                                </div>
                                <div id="medium-solution" class="tab-content mt-4">
                                    <div class="code-block">
                                        <button class="copy-btn">Copy</button>
                                        <pre><code class="language-csharp">public class BankSimulation
{
    public static void Run()
    {
        var account = new BankAccount(1000);
        var threads = new List<Thread>();

        // 5 threads making deposits
        for (int i = 0; i < 5; i++)
        {
            var depositThread = new Thread(() => {
                for(int j = 0; j < 10; j++)
                {
                    account.Deposit(20);
                }
            });
            threads.Add(depositThread);
            depositThread.Start();
        }

        // 5 threads making withdrawals
        for (int i = 0; i < 5; i++)
        {
            var withdrawThread = new Thread(() => {
                for(int j = 0; j < 10; j++)
                {
                    account.Withdraw(15);
                }
            });
            threads.Add(withdrawThread);
            withdrawThread.Start();
        }

        foreach (var thread in threads)
        {
            thread.Join();
        }

        // Expected: 1000 + (5*10*20) - (5*10*15) = 1000 + 1000 - 750 = 1250
        Console.WriteLine($"\nSimulation complete. Final balance: {account.GetBalance():C}");
    }
}

// To run: BankSimulation.Run();</code></pre>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <!-- Hard Problem -->
                        <article id="practice-hard">
                            <h4 class="text-xl font-medium text-slate-700">[Hard] Thread-Safe In-Memory Dictionary</h4>
                            <p class="mt-2 text-slate-600">Implement a generic dictionary-like class (`ThreadSafeDictionary<TKey, TValue>`) that allows multiple threads to safely add, retrieve, and remove items. Note that .NET already provides `ConcurrentDictionary` for this, but this exercise is about implementing the locking yourself.</p>
                            <div class="mt-4">
                                <div class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                        <button class="tab-btn active py-2 px-1 border-b-2 font-medium text-sm" data-tab="hard-solution">C# Solution</button>
                                    </nav>
                                </div>
                                <div id="hard-solution" class="tab-content mt-4">
                                    <div class="code-block">
                                        <button class="copy-btn">Copy</button>
                                        <pre><code class="language-csharp">using System.Collections.Generic;

public class ThreadSafeDictionary<TKey, TValue>
{
    private readonly Dictionary<TKey, TValue> _dict = new Dictionary<TKey, TValue>();
    private readonly object _lock = new object();

    public void Add(TKey key, TValue value)
    {
        lock (_lock)
        {
            _dict[key] = value; // Using indexer handles both add and update
        }
    }

    public bool TryGetValue(TKey key, out TValue value)
    {
        lock (_lock)
        {
            return _dict.TryGetValue(key, out value);
        }
    }

    public bool Remove(TKey key)
    {
        lock (_lock)
        {
            return _dict.Remove(key);
        }
    }

    public int Count
    {
        get
        {
            lock (_lock)
            {
                return _dict.Count;
            }
        }
    }
}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </article>
                    </div>
                </section>

                <!-- UML/Schema Task -->
                <section id="uml" class="mt-16">
                    <h2 class="text-3xl font-bold text-slate-800 border-b pb-2">UML/Schema Task</h2>
                     <article class="mt-8">
                        <h3 class="text-2xl font-semibold text-slate-700">Activity Diagram: Updating Shared Balance</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            This diagram visualizes the flow for a single thread performing a thread-safe update to a shared bank balance. The key element is the "Acquire Lock" action, which creates a fork. If the lock is available, the thread proceeds. If not, it enters a "Wait" state until the lock is released, ensuring only one thread can be in the critical section at a time.
                        </p>
                        <div class="mt-6 p-6 border rounded-lg bg-slate-50 flex flex-col items-center space-y-2 text-center">
                            <div class="p-3 bg-white rounded-full border-2 border-slate-400 font-semibold">Start</div>
                            <div class="h-6 w-0.5 bg-slate-400"></div>
                            <div class="p-3 bg-white rounded-lg border-2 border-slate-400 w-56 hover:bg-cyan-50 hover:border-cyan-500 transition-colors">Thread attempts to update balance</div>
                            <div class="h-6 w-0.5 bg-slate-400"></div>
                            <div class="p-4 bg-cyan-100 text-cyan-800 rounded-lg border-2 border-cyan-500 w-56 font-bold hover:bg-cyan-200 transition-colors">Acquire Lock on Balance Object</div>
                            <div class="h-6 w-0.5 bg-slate-400"></div>
                            <div class="w-56 h-20 p-2 border-2 border-dashed border-slate-400 rounded-lg relative flex items-center justify-center font-semibold text-slate-500">
                                CRITICAL SECTION
                                <div class="absolute -top-12 -right-32 space-y-2 hidden lg:block">
                                    <div class="p-2 bg-yellow-100 rounded-lg border-2 border-yellow-400 w-48 text-sm">Other threads trying to acquire lock are blocked</div>
                                    <div class="h-6 w-0.5 bg-yellow-400 ml-24"></div>
                                    <div class="p-2 bg-yellow-100 rounded-lg border-2 border-yellow-400 w-48 text-sm">Wait until lock is released</div>
                                </div>
                            </div>
                            <div class="space-y-2 p-4">
                                <div class="h-6 w-0.5 bg-slate-400 mx-auto"></div>
                                <div class="p-3 bg-white rounded-lg border-2 border-slate-400 w-56 hover:bg-cyan-50 hover:border-cyan-500 transition-colors">Read current balance</div>
                                <div class="h-6 w-0.5 bg-slate-400 mx-auto"></div>
                                <div class="p-3 bg-white rounded-lg border-2 border-slate-400 w-56 hover:bg-cyan-50 hover:border-cyan-500 transition-colors">Calculate new balance</div>
                                <div class="h-6 w-0.5 bg-slate-400 mx-auto"></div>
                                <div class="p-3 bg-white rounded-lg border-2 border-slate-400 w-56 hover:bg-cyan-50 hover:border-cyan-500 transition-colors">Write new balance</div>
                            </div>
                            <div class="w-56 h-1 border-2 border-dashed border-slate-400 rounded-lg"></div>
                            <div class="h-6 w-0.5 bg-slate-400"></div>
                            <div class="p-4 bg-cyan-100 text-cyan-800 rounded-lg border-2 border-cyan-500 w-56 font-bold hover:bg-cyan-200 transition-colors">Release Lock</div>
                            <div class="h-6 w-0.5 bg-slate-400"></div>
                            <div class="p-3 bg-white rounded-full border-2 border-slate-400 font-semibold">End</div>
                        </div>
                    </article>
                </section>
                
                <!-- Case Study -->
                <section id="case-study" class="mt-16">
                    <h2 class="text-3xl font-bold text-slate-800 border-b pb-2">Case Study / Machine Coding</h2>
                     <article class="mt-8">
                        <h3 class="text-2xl font-semibold text-slate-700">Design: E-commerce Shopping Cart</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            In an e-commerce system, a user's shopping cart is a shared resource. The user might add an item from one browser tab while removing another from a mobile app. These concurrent operations can lead to an inconsistent cart total and item list if not handled correctly.
                        </p>
                        <div class="mt-6 space-y-4">
                            <p><strong>Problem:</strong> A user adds a $50 item and removes a $20 item at roughly the same time.</p>
                            <p><strong>Race Condition without Lock:</strong>
                            <br>1. Thread A (Add) reads total: $100.
                            <br>2. Thread B (Remove) reads total: $100.
                            <br>3. Thread A calculates new total: $150.
                            <br>4. Thread B calculates new total: $80.
                            <br>5. Thread A writes total: $150.
                            <br>6. Thread B writes total: $80.
                            <br>The final total is $80, but it should be $130. A $50 item was effectively lost.
                            </p>
                            <p><strong>Solution: Apply Locks</strong></p>
                            <p class="mt-2 text-slate-600">The entire operation of modifying the cart (adding, removing, updating quantity) must be treated as a critical section. A lock should be placed around any code that modifies the list of items or recalculates the total.</p>
                        </div>
                        <div class="code-block mt-4">
                            <button class="copy-btn">Copy</button>
                            <pre><code class="language-csharp">public class ShoppingCart
{
    private readonly List<CartItem> _items = new List<CartItem>();
    private readonly object _cartLock = new object();
    
    public void AddItem(CartItem item)
    {
        lock (_cartLock)
        {
            // Logic to add item or update quantity if it already exists
            _items.Add(item);
        }
    }
    
    public void RemoveItem(int productId)
    {
        lock (_cartLock)
        {
            // Logic to find and remove item by product ID
            _items.RemoveAll(item => item.ProductId == productId);
        }
    }
    
    public decimal GetTotal()
    {
        lock (_cartLock)
        {
            return _items.Sum(item => item.Price * item.Quantity);
        }
    }
}

public class CartItem 
{
    public int ProductId { get; set; }
    public decimal Price { get; set; }
    public int Quantity { get; set; }
}</code></pre>
                        </div>
                    </article>
                </section>
                
                <!-- Knowledge Check -->
                <section id="quiz" class="mt-16">
                    <h2 class="text-3xl font-bold text-slate-800 border-b pb-2">Knowledge Check Quiz</h2>
                    <div id="quiz-container" class="mt-8 space-y-8"></div>
                    <div id="quiz-results" class="mt-8 hidden p-6 bg-cyan-50 border border-cyan-200 rounded-lg text-center">
                        <h3 class="text-2xl font-semibold text-cyan-800">Quiz Complete!</h3>
                        <p class="mt-2 text-lg text-cyan-700">You scored <span id="quiz-score" class="font-bold"></span> out of <span id="quiz-total" class="font-bold"></span>.</p>
                        <button id="quiz-retry-btn" class="mt-4 px-6 py-2 bg-cyan-600 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-700 transition-colors">Try Again</button>
                    </div>
                </section>

                <!-- Self-Assessment Challenge -->
                <section id="challenge" class="mt-16">
                    <h2 class="text-3xl font-bold text-slate-800 border-b pb-2">Self-Assessment Challenge</h2>
                    <article class="mt-8">
                        <h3 class="text-2xl font-semibold text-slate-700">Task: A Thread-Safe Logger</h3>
                        <p class="mt-4 text-slate-600 leading-relaxed">
                            Your challenge is to create a simple `Logger` class that can write messages to a single file from multiple threads without interleaving or corrupting the log entries. The `Log` method will be called concurrently from several threads.
                        </p>
                        <ul class="list-disc list-inside mt-4 text-slate-600 space-y-1">
                            <li>The `Logger` should be a singleton (only one instance can exist).</li>
                            <li>It should have a single public method: `void Log(string message)`.</li>
                            <li>This method must append the message to a file named `app.log` in a thread-safe manner. Each log entry should include a timestamp.</li>
                        </ul>
                        <div class="mt-6">
                            <button id="show-solution-btn" class="px-5 py-2 border border-slate-300 text-slate-700 font-semibold rounded-lg hover:bg-slate-100 transition-colors">Show Solution</button>
                            <div id="challenge-solution" class="hidden mt-4">
                                <div class="code-block">
                                    <button class="copy-btn">Copy</button>
                                    <pre><code class="language-csharp">using System;
using System.IO;
using System.Threading;

public sealed class Logger
{
    // Lazy<T> is thread-safe for initialization by default
    private static readonly Lazy<Logger> _instance = new Lazy<Logger>(() => new Logger());
    private readonly object _logLock = new object();
    private const string FilePath = "app.log";

    // Private constructor for singleton
    private Logger() 
    {
        // Clear log file on start for clean demo
        File.WriteAllText(FilePath, string.Empty);
    }

    public static Logger Instance => _instance.Value;

    public void Log(string message)
    {
        lock (_logLock)
        {
            string logEntry = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss.fff}] [Thread {Thread.CurrentThread.ManagedThreadId:00}] {message}{Environment.NewLine}";
            File.AppendAllText(FilePath, logEntry);
        }
    }
}

// Example Usage:
public class LoggerChallenge
{
    public static void Run()
    {
        var threads = new List<Thread>();
        for (int i = 0; i < 10; i++)
        {
            int threadNum = i;
            var t = new Thread(() => {
                for (int j = 0; j < 5; j++)
                {
                    Logger.Instance.Log($"This is message {j} from worker {threadNum}.");
                    Thread.Sleep(20);
                }
            });
            threads.Add(t);
            t.Start();
        }

        foreach (var t in threads)
        {
            t.Join();
        }

        Console.WriteLine("Logging complete. Check app.log file.");
    }
}</code></pre>
                                </div>
                            </div>
                        </div>
                    </article>
                </section>
            </main>

            <!-- Sticky TOC -->
            <aside class="w-full lg:w-1/4 lg:sticky top-28 self-start">
                <div class="p-4 bg-white/80 backdrop-blur-sm rounded-lg border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800">On this page</h3>
                    <nav id="toc" class="mt-4">
                        <ul class="space-y-2">
                            <li><a href="#theory" class="toc-link block border-l-2 border-transparent pl-4 text-slate-600 hover:text-cyan-600">Theory Deep Dive</a>
                                <ul class="space-y-2 mt-2 ml-4">
                                    <li><a href="#theory-race-condition" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">Race Conditions</a></li>
                                    <li><a href="#visualization" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">Interactive Demo</a></li>
                                    <li><a href="#theory-critical-section" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">Critical Sections</a></li>
                                    <li><a href="#theory-locking" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">Locking Mechanisms</a></li>
                                    <li><a href="#theory-deadlocks" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">Deadlocks</a></li>
                                </ul>
                            </li>
                            <li><a href="#practice" class="toc-link block border-l-2 border-transparent pl-4 text-slate-600 hover:text-cyan-600">Coding Practice</a>
                                 <ul class="space-y-2 mt-2 ml-4">
                                    <li><a href="#practice-bank-account" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">BankAccount Class</a></li>
                                    <li><a href="#practice-easy" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">[Easy] Number Printer</a></li>
                                    <li><a href="#practice-medium" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">[Medium] Bank Sim</a></li>
                                    <li><a href="#practice-hard" class="toc-link block border-l-2 border-transparent pl-4 text-sm text-slate-500 hover:text-cyan-600">[Hard] Safe Dictionary</a></li>
                                 </ul>
                            </li>
                            <li><a href="#uml" class="toc-link block border-l-2 border-transparent pl-4 text-slate-600 hover:text-cyan-600">UML Activity Diagram</a></li>
                            <li><a href="#case-study" class="toc-link block border-l-2 border-transparent pl-4 text-slate-600 hover:text-cyan-600">Case Study: E-comm Cart</a></li>
                            <li><a href="#quiz" class="toc-link block border-l-2 border-transparent pl-4 text-slate-600 hover:text-cyan-600">Knowledge Check</a></li>
                            <li><a href="#challenge" class="toc-link block border-l-2 border-transparent pl-4 text-slate-600 hover:text-cyan-600">Self-Assessment</a></li>
                        </ul>
                    </nav>
                </div>
            </aside>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="text-center mt-16 py-8 border-t border-slate-200">
        <p class="text-slate-700 font-semibold">Low-Level Design Bootcamp</p>
        <p class="text-sm text-slate-500 mt-2">A personalized learning roadmap curated by Mr. Mahesh Singare.</p>
        <p class="text-xs text-slate-400 mt-4">&copy; 2025. All Rights Reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Copy to Clipboard functionality ---
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const pre = button.parentElement;
                    const code = pre.querySelector('code');
                    const text = code.innerText;
                    navigator.clipboard.writeText(text).then(() => {
                        button.textContent = 'Copied!';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
            });

            // --- Tab functionality ---
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const parent = button.closest('article');
                    parent.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    parent.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    const tabId = button.getAttribute('data-tab');
                    const contentToShow = parent.querySelector(`#${tabId}`);
                    if (contentToShow) {
                        contentToShow.style.display = 'block';
                    }
                });
            });

             // --- Sticky TOC active state ---
            const sections = document.querySelectorAll('main section');
            const tocLinks = document.querySelectorAll('#toc a');
            const headerEl = document.querySelector('.sticky.top-0');
            const headerHeight = headerEl ? headerEl.offsetHeight : 0;

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const id = entry.target.getAttribute('id');
                    const link = document.querySelector(`#toc a[href="#${id}"]`);
                    if (entry.isIntersecting && entry.intersectionRatio > 0.1) {
                         tocLinks.forEach(l => l.classList.remove('active'));
                         if(link) {
                            const parentLi = link.closest('ul').closest('li');
                            if (parentLi) {
                                const parentLink = parentLi.querySelector('a');
                                if (parentLink) parentLink.classList.add('active');
                            }
                            link.classList.add('active');
                         }
                    }
                });
            }, { rootMargin: `-${headerHeight + 20}px 0px -60% 0px`, threshold: 0.1 });

            // Observe sections and key articles
            document.querySelectorAll('main section, main article[id^="theory-"], main article[id^="practice-"]').forEach(el => {
                observer.observe(el);
            });


            // --- Self-Assessment Challenge Solution Toggle ---
            const showSolutionBtn = document.getElementById('show-solution-btn');
            const solutionDiv = document.getElementById('challenge-solution');
            showSolutionBtn.addEventListener('click', () => {
                solutionDiv.classList.toggle('hidden');
                showSolutionBtn.textContent = solutionDiv.classList.contains('hidden') ? 'Show Solution' : 'Hide Solution';
            });
            
            // --- Interactive Race Condition Visualization ---
            const runSimBtn = document.getElementById('run-simulation-btn');
            const unlockedCounterEl = document.getElementById('unlocked-counter');
            const lockedCounterEl = document.getElementById('locked-counter');
            const unlockedResultEl = document.getElementById('unlocked-result');
            const lockedResultEl = document.getElementById('locked-result');
            
            runSimBtn.addEventListener('click', () => {
                runSimBtn.disabled = true;
                runSimBtn.textContent = 'Running...';
                
                unlockedCounterEl.textContent = '0';
                lockedCounterEl.textContent = '0';
                unlockedResultEl.textContent = '?';
                lockedResultEl.textContent = '?';
                unlockedResultEl.classList.remove('text-red-600', 'text-green-600');
                lockedResultEl.classList.remove('text-red-600', 'text-green-600');
                
                let unlockedCounter = 0;
                let lockedCounter = 0;
                const increments = 100;

                // Unlocked simulation
                const runUnlocked = (callback) => {
                    let completed = 0;
                    for(let i = 0; i < increments * 2; i++){
                        // Simulate non-atomic read-modify-write
                        const delay = Math.random() * 25;
                        setTimeout(() => {
                            let temp = unlockedCounter;
                            // small delay to simulate context switch
                            setTimeout(() => {
                                unlockedCounter = temp + 1;
                                unlockedCounterEl.textContent = unlockedCounter; // Update UI as it happens
                                completed++;
                                if (completed === increments * 2) callback();
                            }, Math.random() * 5);
                        }, delay);
                    }
                };
                
                // Locked simulation (visualized as a clean, ordered process)
                const runLocked = (callback) => {
                     let completed = 0;
                     for(let i = 0; i < increments * 2; i++) {
                        setTimeout(() => {
                            lockedCounter++;
                            lockedCounterEl.textContent = lockedCounter;
                            completed++;
                            if (completed === increments * 2) callback();
                        }, i * 10);
                     }
                };

                runUnlocked(() => {
                     runLocked(() => {
                        // Final update after animations
                        unlockedResultEl.textContent = unlockedCounter;
                        unlockedResultEl.classList.add(unlockedCounter === 200 ? 'text-green-600' : 'text-red-600');
                        
                        lockedResultEl.textContent = lockedCounter;
                        lockedResultEl.classList.add('text-green-600');
                        
                        runSimBtn.disabled = false;
                        runSimBtn.textContent = 'Run Simulation';
                    });
                });
            });

            // --- Quiz Functionality ---
            const quizData = [
                {
                    question: "What is the primary purpose of the `lock` statement in C#?",
                    options: ["To pause a thread for a specific duration.", "To ensure only one thread can execute a piece of code at a time.", "To start a new thread.", "To speed up code execution."],
                    answer: "To ensure only one thread can execute a piece of code at a time."
                },
                {
                    question: "A situation where two threads are blocked forever, each waiting for the other to release a resource, is called a...",
                    options: ["Race Condition", "Critical Section", "Deadlock", "Starvation"],
                    answer: "Deadlock"
                },
                {
                    question: "What is the best practice for the object used in a `lock` statement?",
                    options: ["A public static object.", "The string \"lock\".", "The `this` reference.", "A private readonly object instance."],
                    answer: "A private readonly object instance."
                },
                {
                    question: "The `lock(obj) { ... }` syntax is syntactic sugar for which class?",
                    options: ["Thread", "Task", "Mutex", "Monitor"],
                    answer: "Monitor"
                },
                {
                    question: "Which of the following is NOT a good way to prevent deadlocks?",
                    options: ["Acquiring locks in a consistent, defined order.", "Using `Monitor.TryEnter` with a timeout.", "Using as many locks as possible to be more granular.", "Reducing lock contention by locking for shorter periods."],
                    answer: "Using as many locks as possible to be more granular."
                }
            ];

            const quizContainer = document.getElementById('quiz-container');
            const quizResults = document.getElementById('quiz-results');
            const quizScoreEl = document.getElementById('quiz-score');
            const quizTotalEl = document.getElementById('quiz-total');
            const retryBtn = document.getElementById('quiz-retry-btn');
            
            function buildQuiz() {
                quizContainer.innerHTML = '';
                quizResults.classList.add('hidden');
                quizContainer.style.display = 'block';

                quizData.forEach((q, index) => {
                    const questionEl = document.createElement('div');
                    questionEl.className = 'p-6 bg-white border border-slate-200 rounded-lg';
                    
                    const questionText = document.createElement('p');
                    questionText.className = 'font-semibold text-lg text-slate-800';
                    questionText.textContent = `${index + 1}. ${q.question}`;
                    questionEl.appendChild(questionText);
                    
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'mt-4 space-y-3';
                    
                    q.options.forEach(option => {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'quiz-option p-3 border rounded-lg cursor-pointer transition-colors';
                        optionEl.textContent = option;
                        optionEl.addEventListener('click', () => {
                            if (optionEl.parentElement.querySelector('.selected')) return; // Already answered
                            optionEl.classList.add('selected');
                            checkAnswer(optionEl, q.answer);
                        });
                        optionsContainer.appendChild(optionEl);
                    });
                    
                    questionEl.appendChild(optionsContainer);
                    quizContainer.appendChild(questionEl);
                });
                
                // Add a submit button
                const submitBtn = document.createElement('button');
                submitBtn.id = 'submit-quiz-btn';
                submitBtn.className = 'w-full mt-6 px-6 py-3 bg-cyan-600 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed';
                submitBtn.textContent = 'Submit Answers';
                submitBtn.disabled = true;
                submitBtn.addEventListener('click', showResults);
                quizContainer.appendChild(submitBtn);

                // Check if all questions are answered to enable submit
                quizContainer.addEventListener('click', () => {
                    const selections = quizContainer.querySelectorAll('.quiz-option.selected');
                    submitBtn.disabled = selections.length !== quizData.length;
                });
            }

            function checkAnswer(selectedOption, correctAnswer) {
                const isCorrect = selectedOption.textContent === correctAnswer;
                const options = selectedOption.parentElement.querySelectorAll('.quiz-option');

                if (isCorrect) {
                    selectedOption.classList.add('correct');
                } else {
                    selectedOption.classList.add('incorrect');
                    options.forEach(opt => {
                        if (opt.textContent === correctAnswer) {
                            opt.classList.add('correct');
                        }
                    });
                }
                options.forEach(o => o.style.pointerEvents = 'none');
            }
            
            function showResults() {
                let score = quizContainer.querySelectorAll('.quiz-option.correct.selected').length;
                quizScoreEl.textContent = score;
                quizTotalEl.textContent = quizData.length;
                quizResults.classList.remove('hidden');
                document.getElementById('submit-quiz-btn').style.display = 'none';
            }

            retryBtn.addEventListener('click', buildQuiz);
            
            buildQuiz();
        });
    </script>
</body>
</html>

